<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-family: 'Kanit', sans-serif; }
        .sidebar { height: 100vh; background: #2c3e50; color: white; padding: 20px; position: fixed; width: 250px; }
        .main-content { margin-left: 250px; padding: 30px; }
        .nav-link { color: rgba(255,255,255,0.7); cursor: pointer; margin-bottom: 10px; }
        .nav-link:hover, .nav-link.active { color: white; font-weight: bold; background: rgba(255,255,255,0.1); border-radius: 5px;}
        .order-card { background: white; border-left: 5px solid #ffc107; margin-bottom: 15px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card.served { border-left-color: #198754; opacity: 0.8; }
        .badge-live { animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>üë®‚Äçüç≥ Manager</h3><hr>
    <div class="nav-link active" onclick="showTab('orders', this)">üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Live)</div>
    <div class="nav-link" onclick="showTab('menu', this)">üçî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</div>
</div>

<div class="main-content">
    <div id="tab-orders">
        <h2>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå <span class="badge bg-danger badge-live">Live Connection</span></h2>
        <div id="ordersList" class="mt-4 row">Loading...</div>
    </div>

    <div id="tab-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
            <button class="btn btn-primary" onclick="addMenu()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <table class="table table-hover bg-white rounded shadow-sm">
            <thead class="table-dark"><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody id="menuTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // Config ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Tab System ---
    function showTab(tabName, btn) {
        document.getElementById('tab-orders').classList.add('d-none');
        document.getElementById('tab-menu').classList.add('d-none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.remove('d-none');
        if(btn) btn.classList.add('active');

        if(tabName === 'orders') fetchOrders();
        if(tabName === 'menu') fetchMenu();
    }

    // --- Orders System ---
    async function fetchOrders() {
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', {ascending: false});
            if (error) throw error;
            renderOrders(data || []);
        } catch (err) {
            console.error(err);
            // ‡∏ñ‡πâ‡∏≤ Error 404 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Project ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Active
            document.getElementById('ordersList').innerHTML = `<div class="alert alert-danger">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Project ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Paused): ${err.message}</div>`;
        }
    }

    function renderOrders(orders) {
        const list = document.getElementById('ordersList');
        list.innerHTML = '';
        if(orders.length === 0) list.innerHTML = '<p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...</p>';
        
        orders.forEach(o => {
            if(o.status === 'paid') return;
            const itemsHtml = o.items.map(i => `<li>${i.name}</li>`).join('');
            const btn = o.status === 'pending' 
                ? `<button class="btn btn-success w-100" onclick="updateStatus(${o.id}, 'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</button>`
                : `<button class="btn btn-secondary w-100" onclick="updateStatus(${o.id}, 'paid')">üí∞ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>`;

            list.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="order-card ${o.status}">
                        <div class="d-flex justify-content-between">
                            <h5>‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5>
                            <small>${new Date(o.created_at).toLocaleTimeString('th-TH')}</small>
                        </div>
                        <ul class="text-muted small my-2">${itemsHtml}</ul>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <h5 class="m-0 text-primary">${o.total_price} ‡∏ø</h5>
                            <div style="width:120px">${btn}</div>
                        </div>
                    </div>
                </div>`;
        });
    }

    async function updateStatus(id, status) {
        await db.from('orders').update({ status }).eq('id', id);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fetch ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Realtime ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    }

    // --- Realtime ---
    db.channel('admin-room').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, 
        () => fetchOrders()
    ).subscribe((status) => {
        if (status === 'SUBSCRIBED') {
            console.log('Realtime Connected!');
        }
    });

    // --- Menu System ---
    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        data.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td>${m.category}</td>
                    <td>${m.is_available ? '<span class="badge bg-success">‡∏Ç‡∏≤‡∏¢</span>' : '<span class="badge bg-secondary">‡∏´‡∏°‡∏î</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="toggleMenu(${m.id}, ${!m.is_available})">‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenu(${m.id})">‡∏•‡∏ö</button>
                    </td>
                </tr>`;
        });
    }

    async function addMenu() {
        const { value: formValues } = await Swal.fire({
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà',
            html:
                '<input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π">' +
                '<input id="swal-price" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">' +
                '<input id="swal-cat" class="swal2-input" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å)">',
            focusConfirm: false,
            preConfirm: () => {
                return [
                    document.getElementById('swal-name').value,
                    document.getElementById('swal-price').value,
                    document.getElementById('swal-cat').value
                ]
            }
        });

        if (formValues && formValues[0]) {
            await db.from('menu_items').insert([{ 
                name: formValues[0], 
                price: parseInt(formValues[1]), 
                category: formValues[2] 
            }]);
            fetchMenu();
        }
    }

    async function toggleMenu(id, status) {
        await db.from('menu_items').update({ is_available: status }).eq('id', id);
        fetchMenu();
    }

    async function deleteMenu(id) {
        if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) {
            await db.from('menu_items').delete().eq('id', id);
            fetchMenu();
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    fetchOrders();
</script>
</body>

</html>
