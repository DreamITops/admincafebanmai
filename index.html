<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar */
        .sidebar { 
            width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; 
            padding: 20px; z-index: 100; transition: all 0.3s ease; overflow-x: hidden;
        }
        .main { margin-left: 260px; padding: 30px; transition: all 0.3s ease; }
        .nav-item { 
            padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #ccc; 
            display: flex; align-items: center; gap: 15px; white-space: nowrap; overflow: hidden;
        }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; font-weight: bold; }
        .nav-item i { min-width: 20px; text-align: center; font-size: 1.1rem; }

        /* Minimized Sidebar */
        body.sidebar-mini .sidebar { width: 80px; padding: 20px 10px; }
        body.sidebar-mini .main { margin-left: 80px; }
        body.sidebar-mini .nav-text, body.sidebar-mini .sidebar-header-text { display: none; }
        body.sidebar-mini .nav-item { justify-content: center; }

        /* Image Upload */
        .img-preview-box { width: 120px; height: 120px; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin: 0 auto; background: #f9f9f9;}
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        /* Report Chart Bar */
        .bar-container { height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; background: #28a745; transition: width 0.5s; }

        @media(max-width: 992px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

<div class="sidebar d-none d-lg-block">
    <div class="d-flex align-items-center justify-content-between mb-4 ps-2">
        <h4 class="m-0 text-warning fw-bold sidebar-header-text"><i class="fas fa-utensils"></i> Admin</h4>
        <button class="btn btn-sm btn-outline-secondary text-white border-0" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-home"></i> <span class="nav-text">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></div>
    <div class="nav-item" onclick="switchTab('menu', this)"><i class="fas fa-book"></i> <span class="nav-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span></div>
    <div class="nav-item" onclick="switchTab('report', this)"><i class="fas fa-chart-line"></i> <span class="nav-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span></div>
    <div class="nav-item mt-5 text-danger" onclick="location.reload()"><i class="fas fa-sync"></i> <span class="nav-text">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</span></div>
</div>

<div class="main">
    <div class="d-lg-none mb-3 d-flex justify-content-between">
        <h4 class="fw-bold">Admin Pro</h4>
        <div>
            <button class="btn btn-outline-dark btn-sm me-1" onclick="switchTab('dashboard')">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button class="btn btn-outline-dark btn-sm" onclick="switchTab('menu')">‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
    </div>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-6"><div class="card p-3 border-start border-4 border-primary"><h3><i class="fas fa-chair"></i> <span id="activeTables">0</span></h3><small>‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</small></div></div>
            <div class="col-6"><div class="card p-3 border-start border-4 border-success"><h3><i class="fas fa-coins"></i> <span id="pendingSales">0</span></h3><small>‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</small></div></div>
        </div>
        <h5 class="fw-bold"><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
        <div class="row" id="orderGrid"><div class="col-12 text-center py-5">Loading...</div></div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
            <button class="btn btn-primary" onclick="openMenuModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
        <div class="card"><div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light"><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="menuTableBody"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
            </table>
        </div></div>
    </div>

    <div id="view-report" class="d-none">
        <h3 class="mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h3>
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dailyReport" onclick="renderReport('daily')">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#monthlyReport" onclick="renderReport('monthly')">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
        </ul>
        
        <div class="card p-3 mb-3 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="text-muted mb-0">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h5>
                    <h2 class="fw-bold text-success mb-0" id="reportTotalSales">0 ‡∏ø</h2>
                </div>
                <div class="text-end">
                    <h5 class="text-muted mb-0">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
                    <h3 class="fw-bold text-primary mb-0" id="reportTotalOrders">0</h3>
                </div>
            </div>
        </div>

        <div id="reportContent" class="table-responsive bg-white rounded shadow-sm p-3">
            </div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="editMenuId">
                    <div class="mb-3 text-center">
                        <label class="img-preview-box" for="menuImageFile">
                            <img id="previewImg" src="https://via.placeholder.com/150?text=Upload" alt="Preview">
                            <input type="file" id="menuImageFile" accept="image/*" hidden onchange="previewImage(event)">
                        </label>
                        <small class="text-muted">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</small>
                    </div>
                    <input type="text" id="menuName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" required>
                    <div class="row mb-3">
                        <div class="col-6"><input type="number" id="menuPrice" class="form-control" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required></div>
                        <div class="col-6">
                            <select id="menuCategory" class="form-select">
                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                <option value="‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô">‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fw-bold">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏° (Topping)</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addToppingInput()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                    <div id="toppingContainer" class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3 border-primary">
                    <div class="card-body p-2 d-flex gap-2 align-items-center bg-primary bg-opacity-10">
                        <i class="fas fa-plus-circle text-primary"></i>
                        <select id="quickAddMenu" class="form-select form-select-sm">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ô‡πâ‡∏≥/‡∏≠‡∏≤‡∏´‡∏≤‡∏£) --</option>
                        </select>
                        <button class="btn btn-primary btn-sm text-nowrap" onclick="addItemToOrder()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light"><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th width="120">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-end" width="100">‡∏£‡∏ß‡∏°</th></tr></thead>
                        <tbody id="billItemsDisplay"></tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                    <h5 class="text-muted">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h5>
                    <h3 class="text-primary fw-bold" id="modalTotal">0 ‡∏ø</h3>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-success fw-bold px-4" onclick="checkBin()">üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allMenus = [];
    let currentOrders = [];
    let selectedOrder = null;
    let allPaidOrders = []; // For Report

    // --- Init ---
    fetchOrders();
    db.channel('admin-chan').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => fetchOrders()).subscribe();

    function toggleSidebar() { document.body.classList.toggle('sidebar-mini'); }

    function switchTab(view, btn) {
        document.getElementById('view-dashboard').classList.add('d-none');
        document.getElementById('view-menu').classList.add('d-none');
        document.getElementById('view-report').classList.add('d-none');
        
        document.getElementById('view-'+view).classList.remove('d-none');
        
        if(btn && document.querySelector('.d-lg-block')) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }

        if(view === 'menu') fetchMenu();
        if(view === 'dashboard') fetchOrders();
        if(view === 'report') renderReport('daily');
    }

    // --- Dashboard Logic ---
    async function fetchOrders() {
        const { data, error } = await db.from('orders').select('*').neq('status', 'paid').order('created_at', {ascending:false}); 
        if(error) { 
            if(error.code !== 'PGRST100') document.getElementById('orderGrid').innerHTML = `<div class="col-12 text-center text-danger py-5">Error: ${error.message}</div>`;
            return; 
        }
        currentOrders = data || [];
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';
        document.getElementById('activeTables').innerText = currentOrders.length;
        document.getElementById('pendingSales').innerText = currentOrders.reduce((a,b)=>a+b.total_price,0).toLocaleString();

        if(currentOrders.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>'; return; }

        currentOrders.forEach(o => {
            let badge = o.status==='pending' ? 'bg-warning' : (o.status==='cooking'?'bg-danger':'bg-success');
            let statusText = o.status==='pending' ? '‡∏£‡∏≠‡∏ó‡∏≥' : (o.status==='cooking'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥':'‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß');
            let btn = o.status==='pending' ? `<button class="btn btn-outline-warning w-100 btn-sm mb-2" onclick="setStatus(${o.id},'cooking')">üî• ‡∏õ‡∏£‡∏∏‡∏á</button>` : (o.status==='cooking' ? `<button class="btn btn-success w-100 btn-sm mb-2" onclick="setStatus(${o.id},'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>` : '');
            
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card p-3 mb-3 border-start border-4 border-${badge === 'bg-warning' ? 'warning' : (badge === 'bg-danger' ? 'danger' : 'success')}">
                        <div class="d-flex justify-content-between mb-2"><h5 class="m-0 fw-bold">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5><span class="badge ${badge}">${statusText}</span></div>
                        <div class="bg-light p-2 rounded mb-2 small" style="max-height:100px;overflow-y:auto">
                            ${o.items.map(i=> `<div>- ${i.name} ${i.option?`(${i.option})`:''} <span class="text-muted">x${i.qty||1}</span></div>`).join('')}
                        </div>
                        <h5 class="text-end fw-bold text-primary">${o.total_price} ‡∏ø</h5>
                        ${btn}
                        <button class="btn btn-dark w-100 btn-sm" onclick="openBill(${o.id})">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</button>
                    </div>
                </div>`;
        });
    }

    async function setStatus(id, st) { await db.from('orders').update({status:st}).eq('id', id); fetchOrders(); }

    // --- Bill Management (Upgrade) ---
    async function openBill(id) {
        // Load latest order data
        const { data } = await db.from('orders').select('*').eq('id', id).single();
        selectedOrder = data;

        // Ensure Menu is loaded for Quick Add
        if(allMenus.length === 0) await fetchMenu();
        
        // Populate Quick Add Dropdown
        const select = document.getElementById('quickAddMenu');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ô‡πâ‡∏≥/‡∏≠‡∏≤‡∏´‡∏≤‡∏£) --</option>';
        allMenus.forEach((m, idx) => {
            select.innerHTML += `<option value="${idx}">${m.name} (${m.price}‡∏ø)</option>`;
        });

        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        renderBillItems();
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    function renderBillItems() {
        const tbody = document.getElementById('billItemsDisplay');
        tbody.innerHTML = '';
        let total = 0;

        selectedOrder.items.forEach((item, index) => {
            const qty = item.qty || 1;
            const itemTotal = item.price * qty;
            total += itemTotal;

            tbody.innerHTML += `
                <tr>
                    <td>
                        <div>${item.name} <small class="text-primary">${item.option ? '('+item.option+')' : ''}</small></div>
                        ${item.note ? `<small class="text-danger">*${item.note}</small>` : ''}
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" onclick="adjustItem(${index}, -1)">-</button>
                            <span class="form-control text-center px-0">${qty}</span>
                            <button class="btn btn-outline-secondary" onclick="adjustItem(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td class="text-end fw-bold">${itemTotal}</td>
                </tr>
            `;
        });

        document.getElementById('modalTotal').innerText = total + " ‡∏ø";
        selectedOrder.calculatedTotal = total; // Temporary storage
    }

    async function adjustItem(index, delta) {
        const item = selectedOrder.items[index];
        item.qty = (item.qty || 1) + delta;

        if (item.qty <= 0) {
            if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•?')) {
                item.qty = 1; // Revert
                return;
            }
            selectedOrder.items.splice(index, 1);
        }
        
        // Update DB
        await saveOrderUpdate();
    }

    async function addItemToOrder() {
        const select = document.getElementById('quickAddMenu');
        const index = select.value;
        if(index === "") return;

        const menu = allMenus[index];
        // Create new item object
        const newItem = {
            id: menu.id,
            name: menu.name,
            price: menu.price,
            qty: 1,
            option: '', // Default no option for quick add
            note: ''
        };

        // Check if same item exists (optional, but good for grouping)
        const existing = selectedOrder.items.find(i => i.id === newItem.id && !i.option);
        if(existing) {
            existing.qty = (existing.qty || 1) + 1;
        } else {
            selectedOrder.items.push(newItem);
        }

        await saveOrderUpdate();
        select.value = ""; // Reset dropdown
    }

    async function saveOrderUpdate() {
        // Recalculate Total
        const newTotal = selectedOrder.items.reduce((sum, i) => sum + (i.price * (i.qty || 1)), 0);
        
        await db.from('orders').update({
            items: selectedOrder.items,
            total_price: newTotal
        }).eq('id', selectedOrder.id);

        // Fetch latest to ensure sync
        const { data } = await db.from('orders').select('*').eq('id', selectedOrder.id).single();
        selectedOrder = data;
        renderBillItems();
        fetchOrders(); // Update background dashboard
    }

    async function checkBin() {
        if(confirm('‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢?')) {
            await db.from('orders').update({status:'paid'}).eq('id', selectedOrder.id);
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            fetchOrders();
        }
    }

    // --- Menu Logic ---
    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        allMenus = data || [];
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        allMenus.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td><img src="${m.image_url || 'https://via.placeholder.com/50'}" width="50" height="50" style="object-fit:cover; border-radius:5px;"></td>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td>${m.category}</td>
                    <td>${m.is_available ? '<span class="text-success">‡∏Ç‡∏≤‡∏¢</span>' : '<span class="text-danger">‡∏´‡∏°‡∏î</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMenu(${m.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // --- New Topping Logic ---
    function addToppingInput(name = '', price = 0) {
        const div = document.createElement('div');
        div.className = 'input-group mb-2 topping-row';
        div.innerHTML = `
            <input type="text" class="form-control topping-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≠‡∏ô)" value="${name}">
            <input type="number" class="form-control topping-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°" value="${price}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        document.getElementById('toppingContainer').appendChild(div);
    }

    function openMenuModal() {
        document.getElementById('modalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà";
        document.getElementById('menuForm').reset();
        document.getElementById('editMenuId').value = "";
        document.getElementById('previewImg').src = "https://via.placeholder.com/150?text=Upload";
        document.getElementById('toppingContainer').innerHTML = '';
        addToppingInput(); 
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function editMenu(id) {
        const menu = allMenus.find(m => m.id === id);
        if(!menu) return;
        document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π";
        document.getElementById('editMenuId').value = menu.id;
        document.getElementById('menuName').value = menu.name;
        document.getElementById('menuPrice').value = menu.price;
        document.getElementById('menuCategory').value = menu.category || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        document.getElementById('previewImg').src = menu.image_url || "https://via.placeholder.com/150";
        
        const container = document.getElementById('toppingContainer');
        container.innerHTML = '';
        if(menu.options && Array.isArray(menu.options) && menu.options.length > 0) {
            menu.options.forEach(opt => addToppingInput(opt.name, opt.price));
        } else {
            addToppingInput();
        }
        
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if(file) document.getElementById('previewImg').src = URL.createObjectURL(file);
    }

    async function saveMenu() {
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: ()=>Swal.showLoading()});
        const id = document.getElementById('editMenuId').value;
        const name = document.getElementById('menuName').value;
        const price = parseInt(document.getElementById('menuPrice').value);
        const category = document.getElementById('menuCategory').value;
        
        const toppingRows = document.querySelectorAll('.topping-row');
        let options = [];
        toppingRows.forEach(row => {
            const tName = row.querySelector('.topping-name').value.trim();
            const tPrice = parseInt(row.querySelector('.topping-price').value || 0);
            if(tName) options.push({ name: tName, price: tPrice });
        });

        const fileInput = document.getElementById('menuImageFile');
        let imageUrl = document.getElementById('previewImg').src;
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = `menu_${Date.now()}`;
            const { error } = await db.storage.from('menu_images').upload(fileName, file);
            if (error) { Swal.fire('Error', '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Bucket menu_images ‡∏Å‡πà‡∏≠‡∏ô', 'error'); return; }
            const { data } = db.storage.from('menu_images').getPublicUrl(fileName);
            imageUrl = data.publicUrl;
        }

        const payload = { name, price, category, options, image_url: imageUrl };
        let err;
        if(id) { const res = await db.from('menu_items').update(payload).eq('id', id); err = res.error; }
        else { const res = await db.from('menu_items').insert([payload]); err = res.error; }

        if(err) Swal.fire('Error', err.message, 'error');
        else {
            bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
            fetchMenu();
        }
    }

    async function deleteMenu(id) {
        if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) { await db.from('menu_items').delete().eq('id', id); fetchMenu(); }
    }

    // --- Report Logic (New) ---
    async function renderReport(mode) {
        const tbody = document.getElementById('reportContent');
        tbody.innerHTML = '<div class="text-center py-5">Loading...</div>';

        // Fetch ALL paid orders
        const { data } = await db.from('orders').select('*').eq('status', 'paid').order('created_at', {ascending: true});
        allPaidOrders = data || [];

        let summary = {};
        let totalSales = 0;
        let totalOrders = 0;

        allPaidOrders.forEach(o => {
            const date = new Date(o.created_at);
            let key;
            if(mode === 'daily') key = date.toLocaleDateString('th-TH'); // 25/1/2569
            else key = date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); // ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2569

            if(!summary[key]) summary[key] = { sales: 0, count: 0 };
            summary[key].sales += o.total_price;
            summary[key].count += 1;
            totalSales += o.total_price;
            totalOrders += 1;
        });

        // Update Header Stats
        document.getElementById('reportTotalSales').innerText = totalSales.toLocaleString() + ' ‡∏ø';
        document.getElementById('reportTotalOrders').innerText = totalOrders.toLocaleString();

        // Render Table
        let html = `<table class="table table-bordered table-striped">
            <thead class="table-dark"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th class="text-end">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th class="text-center">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th class="text-center">‡∏Å‡∏£‡∏≤‡∏ü</th></tr></thead><tbody>`;

        if(Object.keys(summary).length === 0) {
            html += `<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</td></tr>`;
        } else {
            // Find max sales for bar chart scale
            const maxSales = Math.max(...Object.values(summary).map(s => s.sales));

            for (const [key, val] of Object.entries(summary)) {
                const percent = (val.sales / maxSales) * 100;
                html += `
                    <tr>
                        <td>${key}</td>
                        <td class="text-end fw-bold text-success">${val.sales.toLocaleString()}</td>
                        <td class="text-center">${val.count}</td>
                        <td width="30%">
                            <div class="bar-container" title="${percent.toFixed(1)}%">
                                <div class="bar-fill" style="width: ${percent}%"></div>
                            </div>
                        </td>
                    </tr>`;
            }
        }
        html += '</tbody></table>';
        tbody.innerHTML = html;
    }

</script>
</body>
</html>
