<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pro - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Kanit', sans-serif; }
        .sidebar { height: 100vh; background: #1a202c; color: white; padding: 20px; position: fixed; width: 250px; overflow-y: auto; }
        .main-content { margin-left: 250px; padding: 30px; }
        .nav-link { color: rgba(255,255,255,0.7); cursor: pointer; margin-bottom: 10px; padding: 10px; border-radius: 8px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #FFC107; color: #333; font-weight: bold; }
        
        .order-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid #FFC107; position: relative; }
        .order-card.served { border-left-color: #198754; }
        .order-card.paid { border-left-color: #6c757d; opacity: 0.7; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .topping-tag { font-size: 0.8rem; background: #e9ecef; padding: 2px 6px; border-radius: 4px; color: #666; margin-left: 5px; }
        
        /* Modal Styles */
        .modal-header { background: #FFC107; color: #333; }
        .price-badge { font-weight: bold; color: #198754; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="mb-4">üë®‚Äçüç≥ Manager Pro</h3>
    <div class="nav-link active" onclick="showTab('orders', this)">üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</div>
    <div class="nav-link" onclick="showTab('menu', this)">üçî ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π & Toppings</div>
</div>

<div class="main-content">
    
    <div id="tab-orders">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå <span class="badge bg-success" style="font-size:0.5em" id="connStatus">Online</span></h2>
            <button class="btn btn-outline-secondary" onclick="fetchOrders()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
        <div id="ordersList" class="row">Loading...</div>
    </div>

    <div id="tab-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
            <button class="btn btn-primary" onclick="openMenuModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <table class="table table-hover bg-white rounded shadow-sm">
            <thead class="table-dark">
                <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
            </thead>
            <tbody id="menuTableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üßæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•: ‡πÇ‡∏ï‡πä‡∏∞ <span id="billTableNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-header bg-light">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</div>
                    <div class="card-body" id="billItemsList">
                        </div>
                    <div class="card-footer d-flex justify-content-between">
                        <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</strong>
                        <strong class="text-success fs-5" id="billTotalDisplay">0 ‡∏ø</strong>
                    </div>
                </div>

                <div class="card bg-light border-0 p-3">
                    <h6>‚ûï ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h6>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <select id="adminMenuSelect" class="form-select" onchange="renderAdminToppingOptions()">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π --</option>
                            </select>
                        </div>
                        <div class="col-md-5" id="adminToppingContainer">
                            </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="adminAddItemToOrder()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                <button type="button" class="btn btn-success btn-lg" id="btnCheckBill" onclick="processPayment()">üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üçî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="menuId">
                    <div class="mb-3">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="menuPrice" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <input type="text" id="menuCategory" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label>Toppings (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°)</label>
                        <p class="text-muted small">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ (,) <br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <code>‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß:10, ‡∏ä‡∏µ‡∏™:15, ‡∏´‡∏°‡∏π‡∏™‡∏±‡∏ö:10</code></p>
                        <textarea id="menuToppings" class="form-control" rows="2" placeholder="‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß:10, ‡∏ä‡∏µ‡∏™:15"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Global Variables ---
    let allMenus = [];
    let currentEditingOrderId = null;
    let currentOrderData = null;

    // --- Initialization ---
    function showTab(tab, btn) {
        document.getElementById('tab-orders').classList.add('d-none');
        document.getElementById('tab-menu').classList.add('d-none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('d-none');
        btn.classList.add('active');
        if(tab === 'orders') fetchOrders();
        if(tab === 'menu') fetchMenu();
    }

    // ================= ORDER SYSTEM =================

    async function fetchOrders() {
        // ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢ (pending, served)
        const { data, error } = await db.from('orders')
            .select('*')
            .neq('status', 'paid')
            .order('created_at', {ascending: false});
        
        const list = document.getElementById('ordersList');
        list.innerHTML = '';

        if(!data || data.length === 0) {
            list.innerHTML = '<div class="col-12 text-center text-muted mt-5"><h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á (‡∏ß‡πà‡∏≤‡∏á)</h4></div>';
            return;
        }

        data.forEach(o => {
            let totalItems = o.items.reduce((acc, i) => acc + (i.qty || 1), 0);
            let btnAction = '';
            
            if(o.status === 'pending') {
                btnAction = `<button class="btn btn-success w-100 mb-2" onclick="updateStatus(${o.id}, 'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</button>`;
            }
            
            list.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="order-card ${o.status}">
                        <div class="d-flex justify-content-between align-items-start">
                            <h4 class="m-0">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h4>
                            <span class="badge bg-secondary">${new Date(o.created_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="my-3">
                            <span class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${totalItems} ‡∏≠‡∏¢‡πà‡∏≤‡∏á</span><br>
                            <span class="fs-4 fw-bold text-primary">${o.total_price} ‡∏ø</span>
                        </div>
                        ${btnAction}
                        <button class="btn btn-outline-dark w-100" onclick="openBillManager(${o.id})">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
                    </div>
                </div>
            `;
        });
    }

    async function updateStatus(id, status) {
        await db.from('orders').update({ status }).eq('id', id);
        // Realtime ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ refresh ‡πÄ‡∏≠‡∏á
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•
    async function openBillManager(orderId) {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const { data } = await db.from('orders').select('*').eq('id', orderId).single();
        currentEditingOrderId = orderId;
        currentOrderData = data;
        
        document.getElementById('billTableNo').innerText = data.table_no;
        renderBillItems();
        
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
        prepareAdminMenuSelect();

        const modal = new bootstrap.Modal(document.getElementById('billModal'));
        modal.show();
    }

    function renderBillItems() {
        const container = document.getElementById('billItemsList');
        container.innerHTML = '';
        let calcTotal = 0;

        currentOrderData.items.forEach((item, index) => {
            let itemTotal = item.price; 
            // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let toppingText = '';
            if(item.selected_toppings && item.selected_toppings.length > 0) {
                item.selected_toppings.forEach(t => {
                    itemTotal += t.price;
                    toppingText += `<span class="topping-tag">+${t.name} (${t.price})</span>`;
                });
            }

            calcTotal += itemTotal;

            container.innerHTML += `
                <div class="item-row">
                    <div>
                        <strong>${item.name}</strong> <span class="text-muted small">(${item.price})</span>
                        ${toppingText}
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="price-badge me-3">${itemTotal} ‡∏ø</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItemFromOrder(${index})">‚ùå</button>
                    </div>
                </div>
            `;
        });

        document.getElementById('billTotalDisplay').innerText = calcTotal + " ‡∏ø";
        currentOrderData.total_price = calcTotal; // Update local variable
    }

    // --- Admin Add Item Logic ---
    function prepareAdminMenuSelect() {
        const sel = document.getElementById('adminMenuSelect');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π --</option>';
        allMenus.forEach((m, idx) => {
            sel.innerHTML += `<option value="${idx}">${m.name} (${m.price}‡∏ø)</option>`;
        });
        document.getElementById('adminToppingContainer').innerHTML = '';
    }

    function renderAdminToppingOptions() {
        const idx = document.getElementById('adminMenuSelect').value;
        const container = document.getElementById('adminToppingContainer');
        container.innerHTML = '';
        
        if(idx === "") return;

        const menu = allMenus[idx];
        if(menu.toppings && menu.toppings.length > 0) {
            menu.toppings.forEach((t, i) => {
                container.innerHTML += `
                    <div class="form-check form-check-inline">
                        <input class="form-check-input admin-top-check" type="checkbox" value="${i}" id="top_${i}">
                        <label class="form-check-label small" for="top_${i}">${t.name} (+${t.price})</label>
                    </div>
                `;
            });
        } else {
            container.innerHTML = '<small class="text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á -</small>';
        }
    }

    async function adminAddItemToOrder() {
        const idx = document.getElementById('adminMenuSelect').value;
        if(idx === "") return;

        const menu = allMenus[idx];
        
        // ‡πÄ‡∏Å‡πá‡∏ö Toppings ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const selectedToppings = [];
        document.querySelectorAll('.admin-top-check:checked').forEach(cb => {
            const tIndex = cb.value;
            selectedToppings.push(menu.toppings[tIndex]);
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        const newItem = {
            name: menu.name,
            price: menu.price,
            qty: 1,
            selected_toppings: selectedToppings
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô Array ‡∏Ç‡∏≠‡∏á Order ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        currentOrderData.items.push(newItem);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        await saveOrderChanges();
        renderBillItems(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    }

    async function removeItemFromOrder(index) {
        if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
        currentOrderData.items.splice(index, 1);
        await saveOrderChanges();
        renderBillItems();
    }

    async function saveOrderChanges() {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let newTotal = 0;
        currentOrderData.items.forEach(item => {
            let itemSum = item.price;
            if(item.selected_toppings) {
                item.selected_toppings.forEach(t => itemSum += t.price);
            }
            newTotal += itemSum;
        });

        await db.from('orders').update({
            items: currentOrderData.items,
            total_price: newTotal
        }).eq('id', currentEditingOrderId);
    }

    async function processPayment() {
        const btn = document.getElementById('btnCheckBill');
        const originalText = btn.innerHTML;
        
        // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (Feedback)
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô...';
        btn.disabled = true;

        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ (UX)
        setTimeout(async () => {
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DB
            await db.from('orders').update({ status: 'paid' }).eq('id', currentEditingOrderId);
            
            // 3. ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'success');
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 800);
    }


    // ================= MENU SYSTEM =================

    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        allMenus = data || []; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Dropdown Admin ‡∏î‡πâ‡∏ß‡∏¢
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        
        allMenus.forEach(m => {
            // Format Topping Display
            let toppingBadge = '-';
            if(m.toppings && Array.isArray(m.toppings) && m.toppings.length > 0) {
                toppingBadge = m.toppings.map(t => `<span class="badge bg-info text-dark">${t.name}:${t.price}</span>`).join(' ');
            }

            tbody.innerHTML += `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td>${m.category}</td>
                    <td>${toppingBadge}</td>
                    <td>${m.is_available ? '<span class="text-success">‡∏Ç‡∏≤‡∏¢</span>' : '<span class="text-danger">‡∏´‡∏°‡∏î</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="toggleMenu(${m.id}, ${!m.is_available})">‡∏™‡∏•‡∏±‡∏ö</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenu(${m.id})">‡∏•‡∏ö</button>
                    </td>
                </tr>`;
        });
    }

    function openMenuModal() {
        document.getElementById('menuForm').reset();
        document.getElementById('menuId').value = '';
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    async function saveMenu() {
        const name = document.getElementById('menuName').value;
        const price = parseInt(document.getElementById('menuPrice').value);
        const category = document.getElementById('menuCategory').value;
        const toppingStr = document.getElementById('menuToppings').value;

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Topping ‡πÄ‡∏õ‡πá‡∏ô JSON Array
        // Format: "‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß:10, ‡∏ä‡∏µ‡∏™:15" -> [{name:'‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', price:10}, ...]
        let toppingsArray = [];
        if(toppingStr.trim() !== "") {
            const parts = toppingStr.split(',');
            parts.forEach(p => {
                const [tName, tPrice] = p.split(':');
                if(tName && tPrice) {
                    toppingsArray.push({
                        name: tName.trim(),
                        price: parseInt(tPrice.trim())
                    });
                }
            });
        }

        const payload = {
            name, price, category, 
            toppings: toppingsArray
        };

        const { error } = await db.from('menu_items').insert([payload]);
        
        if(error) {
            alert('Error: ' + error.message);
        } else {
            bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            fetchMenu();
        }
    }

    async function toggleMenu(id, status) {
        await db.from('menu_items').update({ is_available: status }).eq('id', id);
        fetchMenu();
    }

    async function deleteMenu(id) {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π?')) {
            await db.from('menu_items').delete().eq('id', id);
            fetchMenu();
        }
    }

    // Realtime Listener
    db.channel('admin-pro').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, 
        () => fetchOrders()
    ).subscribe();

    // Start
    fetchOrders();
    fetchMenu(); // Fetch menu ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Dropdown ‡πÉ‡∏´‡πâ Admin
</script>
</body>
</html>
