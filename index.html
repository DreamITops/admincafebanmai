<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- Sidebar Styles --- */
        .sidebar { 
            width: 260px; 
            height: 100vh; 
            background: #2c3e50; 
            color: white; 
            position: fixed; 
            padding: 20px; 
            z-index: 100; 
            transition: all 0.3s ease; /* Animation */
            overflow-x: hidden;
        }

        .main { 
            margin-left: 260px; 
            padding: 30px; 
            transition: all 0.3s ease; /* Animation */
        }

        .nav-item { 
            padding: 12px; 
            margin-bottom: 5px; 
            cursor: pointer; 
            border-radius: 8px; 
            color: #ccc; 
            display: flex; 
            align-items: center; 
            gap: 15px; /* Space between icon and text */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
        }
        
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; font-weight: bold; }
        .nav-item i { min-width: 20px; text-align: center; font-size: 1.1rem; }

        /* --- Minimized State (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠) --- */
        body.sidebar-mini .sidebar { width: 80px; padding: 20px 10px; }
        body.sidebar-mini .main { margin-left: 80px; }
        body.sidebar-mini .nav-text { opacity: 0; pointer-events: none; display: none;} /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
        body.sidebar-mini .sidebar-header-text { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠ App */
        body.sidebar-mini .nav-item { justify-content: center; } /* ‡∏à‡∏±‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        
        /* Image Upload Box */
        .img-preview-box { width: 120px; height: 120px; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin: 0 auto; background: #f9f9f9;}
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        
        @media(max-width: 992px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

<div class="sidebar d-none d-lg-block">
    <div class="d-flex align-items-center justify-content-between mb-4 ps-2">
        <h4 class="m-0 text-warning fw-bold sidebar-header-text"><i class="fas fa-utensils"></i> Admin</h4>
        <button class="btn btn-sm btn-outline-secondary text-white border-0" onclick="toggleSidebar()">
            <i class="fas fa-bars fa-lg"></i>
        </button>
    </div>

    <div class="nav-item active" onclick="switchTab('dashboard', this)">
        <i class="fas fa-home"></i> <span class="nav-text">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
    </div>
    <div class="nav-item" onclick="switchTab('menu', this)">
        <i class="fas fa-book"></i> <span class="nav-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
    </div>
    <div class="nav-item mt-5 text-danger" onclick="location.reload()">
        <i class="fas fa-sync"></i> <span class="nav-text">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</span>
    </div>
</div>

<div class="main">
    <div class="d-lg-none mb-3 d-flex justify-content-between">
        <h4 class="fw-bold">Admin Pro</h4>
        <div>
            <button class="btn btn-outline-dark btn-sm me-1" onclick="switchTab('dashboard')">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <button class="btn btn-outline-dark btn-sm" onclick="switchTab('menu')">‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
    </div>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-6"><div class="card p-3 border-start border-4 border-primary"><h3><i class="fas fa-chair"></i> <span id="activeTables">0</span></h3><small>‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</small></div></div>
            <div class="col-6"><div class="card p-3 border-start border-4 border-success"><h3><i class="fas fa-coins"></i> <span id="pendingSales">0</span></h3><small>‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</small></div></div>
        </div>
        
        <h5 class="fw-bold"><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
        <div class="row" id="orderGrid"><div class="col-12 text-center py-5">Loading...</div></div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
            <button class="btn btn-primary" onclick="openMenuModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
        <div class="card"><div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light"><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="menuTableBody"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
            </table>
        </div></div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="editMenuId">
                    <div class="mb-3 text-center">
                        <label class="img-preview-box" for="menuImageFile">
                            <img id="previewImg" src="https://via.placeholder.com/150?text=Upload" alt="Preview">
                            <input type="file" id="menuImageFile" accept="image/*" hidden onchange="previewImage(event)">
                        </label>
                        <small class="text-muted">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</small>
                    </div>
                    <input type="text" id="menuName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" required>
                    <div class="row mb-2">
                        <div class="col-6"><input type="number" id="menuPrice" class="form-control" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required></div>
                        <div class="col-6">
                            <select id="menuCategory" class="form-select">
                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                <option value="‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô">‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    <label>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Topping)</label>
                    <textarea id="menuOptions" class="form-control" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≠‡∏ô:0, ‡πÄ‡∏¢‡πá‡∏ô:5"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="billItemsDisplay" class="mb-3"></div>
                <h3 class="text-end text-primary fw-bold" id="modalTotal">0 ‡∏ø</h3>
            </div>
            <div class="modal-footer"><button class="btn btn-success w-100 fw-bold" onclick="checkBin()">üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button></div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allMenus = [];
    let currentOrders = [];
    let selectedOrder = null;

    // --- Start ---
    fetchOrders();
    // Realtime Listener
    db.channel('admin-chan').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => fetchOrders()).subscribe();

    // --- Sidebar Toggle Logic ---
    function toggleSidebar() {
        document.body.classList.toggle('sidebar-mini');
    }

    function switchTab(view, btn) {
        document.getElementById('view-dashboard').classList.add('d-none');
        document.getElementById('view-menu').classList.add('d-none');
        document.getElementById('view-'+view).classList.remove('d-none');
        if(btn && document.querySelector('.d-lg-block')) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }
        if(view === 'menu') fetchMenu();
        if(view === 'dashboard') fetchOrders();
    }

    // --- Dashboard Logic ---
    async function fetchOrders() {
        const { data, error } = await db.from('orders')
            .select('*')
            .neq('status', 'paid')
            .order('created_at', {ascending:false}); 
            
        if(error) { 
            console.error("Fetch Error:", error); 
            if(error.code !== 'PGRST100') { 
                 document.getElementById('orderGrid').innerHTML = `<div class="col-12 text-center text-danger py-5">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Console</div>`;
            }
            return; 
        }
        
        currentOrders = data || [];
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';
        document.getElementById('activeTables').innerText = currentOrders.length;
        document.getElementById('pendingSales').innerText = currentOrders.reduce((a,b)=>a+b.total_price,0).toLocaleString();

        if(currentOrders.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>'; return; }

        currentOrders.forEach(o => {
            let badge = o.status==='pending' ? 'bg-warning' : (o.status==='cooking'?'bg-danger':'bg-success');
            let statusText = o.status==='pending' ? '‡∏£‡∏≠‡∏ó‡∏≥' : (o.status==='cooking'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥':'‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß');
            let btn = o.status==='pending' ? `<button class="btn btn-outline-warning w-100 btn-sm mb-2" onclick="setStatus(${o.id},'cooking')">üî• ‡∏õ‡∏£‡∏∏‡∏á</button>` : (o.status==='cooking' ? `<button class="btn btn-success w-100 btn-sm mb-2" onclick="setStatus(${o.id},'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>` : '');
            
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card p-3 mb-3 border-start border-4 border-${badge === 'bg-warning' ? 'warning' : (badge === 'bg-danger' ? 'danger' : 'success')}">
                        <div class="d-flex justify-content-between mb-2"><h5 class="m-0 fw-bold">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5><span class="badge ${badge}">${statusText}</span></div>
                        <div class="bg-light p-2 rounded mb-2 small" style="max-height:100px;overflow-y:auto">
                            ${o.items.map(i=> `<div>- ${i.name} ${i.option?`(${i.option})`:''}</div>`).join('')}
                        </div>
                        <h5 class="text-end fw-bold text-primary">${o.total_price} ‡∏ø</h5>
                        ${btn}
                        <button class="btn btn-dark w-100 btn-sm" onclick="openBill(${o.id})">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</button>
                    </div>
                </div>`;
        });
    }

    async function setStatus(id, st) { await db.from('orders').update({status:st}).eq('id', id); fetchOrders(); }

    function openBill(id) {
        selectedOrder = currentOrders.find(o=>o.id===id);
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        document.getElementById('modalTotal').innerText = selectedOrder.total_price + ' ‡∏ø';
        document.getElementById('billItemsDisplay').innerHTML = selectedOrder.items.map(i=>
            `<div class="d-flex justify-content-between border-bottom py-1"><span>${i.name} ${i.option?`(${i.option})`:''}</span><b>${i.price}</b></div>`
        ).join('');
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    async function checkBin() {
        if(confirm('‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢?')) {
            await db.from('orders').update({status:'paid'}).eq('id', selectedOrder.id);
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            fetchOrders();
        }
    }

    // --- Menu Logic ---
    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        allMenus = data || [];
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        allMenus.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td><img src="${m.image_url || 'https://via.placeholder.com/50'}" width="50" height="50" style="object-fit:cover; border-radius:5px;"></td>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td>${m.category}</td>
                    <td>${m.is_available ? '<span class="text-success">‡∏Ç‡∏≤‡∏¢</span>' : '<span class="text-danger">‡∏´‡∏°‡∏î</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMenu(${m.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    function openMenuModal() {
        document.getElementById('modalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà";
        document.getElementById('menuForm').reset();
        document.getElementById('editMenuId').value = "";
        document.getElementById('previewImg').src = "https://via.placeholder.com/150?text=Upload";
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function editMenu(id) {
        const menu = allMenus.find(m => m.id === id);
        if(!menu) return;
        document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π";
        document.getElementById('editMenuId').value = menu.id;
        document.getElementById('menuName').value = menu.name;
        document.getElementById('menuPrice').value = menu.price;
        document.getElementById('menuCategory').value = menu.category || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        document.getElementById('previewImg').src = menu.image_url || "https://via.placeholder.com/150";
        
        let optStr = "";
        if(menu.options && Array.isArray(menu.options)) optStr = menu.options.map(o => `${o.name}:${o.price}`).join(', ');
        document.getElementById('menuOptions').value = optStr;
        
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if(file) document.getElementById('previewImg').src = URL.createObjectURL(file);
    }

    async function saveMenu() {
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: ()=>Swal.showLoading()});
        const id = document.getElementById('editMenuId').value;
        const name = document.getElementById('menuName').value;
        const price = parseInt(document.getElementById('menuPrice').value);
        const category = document.getElementById('menuCategory').value;
        const optText = document.getElementById('menuOptions').value;
        const fileInput = document.getElementById('menuImageFile');

        let options = [];
        if(optText.trim() !== "") {
            options = optText.split(',').map(item => {
                const p = item.split(':');
                return { name: p[0].trim(), price: parseInt(p[1] || 0) };
            });
        }

        let imageUrl = document.getElementById('previewImg').src;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = `menu_${Date.now()}`;
            const { error } = await db.storage.from('menu_images').upload(fileName, file);
            if (error) { Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Bucket "menu_images" ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Public ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'error'); return; }
            const { data } = db.storage.from('menu_images').getPublicUrl(fileName);
            imageUrl = data.publicUrl;
        }

        const payload = { name, price, category, options, image_url: imageUrl };
        let err;
        if(id) { const res = await db.from('menu_items').update(payload).eq('id', id); err = res.error; }
        else { const res = await db.from('menu_items').insert([payload]); err = res.error; }

        if(err) Swal.fire('Error', err.message, 'error');
        else {
            bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
            fetchMenu();
        }
    }

    async function deleteMenu(id) {
        if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) { await db.from('menu_items').delete().eq('id', id); fetchMenu(); }
    }
</script>
</body>
</html>
