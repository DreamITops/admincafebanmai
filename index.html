<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #eef2f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Layout */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; padding: 20px; transition: 0.3s; z-index: 100; }
        .main { margin-left: 260px; padding: 30px; transition: 0.3s; }
        
        /* Nav Item */
        .nav-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #b0b8c1; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; }
        .nav-item i { width: 25px; text-align: center; }

        /* Order Card */
        .order-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; border-left: 5px solid #f1c40f; position: relative; overflow: hidden; }
        .order-card.cooking { border-left-color: #e67e22; }
        .order-card.served { border-left-color: #27ae60; }
        
        /* Header Stats */
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: space-between; }
        
        /* Responsive */
        @media(max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
            .show-sidebar .sidebar { transform: translateX(0); }
        }
        
        /* Print Style */
        @media print {
            body * { visibility: hidden; }
            #receiptArea, #receiptArea * { visibility: visible; }
            #receiptArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h4 class="mb-4 ps-2 fw-bold"><i class="fas fa-utensils text-warning"></i> RestoPro</h4>
    <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° & ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
    <div class="nav-item" onclick="switchTab('menu')"><i class="fas fa-book-open"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</div>
    <div class="nav-item text-danger mt-5" onclick="location.reload()"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="main">
    <button class="btn btn-dark d-md-none mb-3" onclick="document.body.classList.toggle('show-sidebar')">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                        <h3 class="fw-bold text-success" id="todaySales">0 ‡∏ø</h3>
                    </div>
                    <i class="fas fa-coins fa-2x text-success opacity-25"></i>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</h6>
                        <h3 class="fw-bold text-primary" id="activeTables">0</h3>
                    </div>
                    <i class="fas fa-chair fa-2x text-primary opacity-25"></i>
                </div>
            </div>
        </div>

        <h5 class="fw-bold mb-3">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h5>
        <div class="row" id="orderGrid">Loading...</div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
            <button class="btn btn-primary" onclick="alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
        <div class="alert alert-info">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="billItems" class="mb-3"></div>
                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                    <span class="text-primary" id="modalTotal">0 ‡∏ø</span>
                </div>
                
                <div id="receiptArea" class="d-none bg-white p-3 text-center" style="width: 300px; font-family: monospace;">
                    <h4 class="fw-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4>
                    <p>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢ Pro</p>
                    <hr>
                    <div id="printItems" class="text-start"></div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>TOTAL</span>
                        <span id="printTotal">0</span>
                    </div>
                    <p class="mt-3 small">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                </div>

            </div>
            <div class="modal-footer flex-column">
                <div class="d-flex gap-2 w-100">
                    <button class="btn btn-outline-dark flex-grow-1" onclick="printBill()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    <button class="btn btn-success flex-grow-1" onclick="checkBin()"><i class="fas fa-money-bill-wave"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞)</button>
                </div>
                <button class="btn btn-link text-danger w-100" onclick="cancelOrder()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = '‡πÉ‡∏™‡πà_URL_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
    const SUPABASE_KEY = '‡πÉ‡∏™‡πà_KEY_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentOrders = [];
    let selectedOrder = null;

    // --- Init ---
    fetchData();
    
    // Realtime Listener
    db.channel('admin-chan').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, 
        () => fetchData()
    ).subscribe();

    async function fetchData() {
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'paid'
        const { data } = await db.from('orders').select('*').neq('status', 'paid').order('created_at');
        currentOrders = data;
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';

        // Update Stats
        document.getElementById('activeTables').innerText = currentOrders.length;
        // (‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á Query ‡∏à‡∏≤‡∏Å DB ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ filter status='paid' ‡πÅ‡∏•‡∏∞ created_at = today)
        
        if(currentOrders.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>';
            return;
        }

        currentOrders.forEach(o => {
            // Logic ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusBadge = '';
            let nextBtn = '';

            if(o.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß</span>';
                nextBtn = `<button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="setStatus(${o.id}, 'cooking')">üî• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</button>`;
            } else if(o.status === 'cooking') {
                statusBadge = '<span class="badge bg-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á</span>';
                nextBtn = `<button class="btn btn-sm btn-success w-100 mb-2" onclick="setStatus(${o.id}, 'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>`;
            } else {
                statusBadge = '<span class="badge bg-success">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</span>';
            }

            const itemsCount = o.items.length;
            
            grid.innerHTML += `
                <div class="col-md-4 col-lg-3">
                    <div class="order-card ${o.status}">
                        <div class="p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="fw-bold m-0">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5>
                                ${statusBadge}
                            </div>
                            <p class="text-muted small">${new Date(o.created_at).toLocaleTimeString('th-TH')} ‚Ä¢ ${itemsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            
                            <div class="bg-light p-2 rounded mb-3" style="max-height:100px; overflow-y:auto; font-size:0.85rem;">
                                ${o.items.map(i => `<div>- ${i.name} ${i.option ? '('+i.option+')' : ''}</div>`).join('')}
                            </div>

                            <h4 class="fw-bold text-end text-primary mb-3">${o.total_price} ‡∏ø</h4>
                            
                            ${nextBtn}
                            <button class="btn btn-dark w-100" onclick="openBill(${o.id})">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    async function setStatus(id, status) {
        await db.from('orders').update({status}).eq('id', id);
        // fetchData() ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô Realtime
    }

    // --- Bill Management ---
    function openBill(id) {
        selectedOrder = currentOrders.find(o => o.id === id);
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        document.getElementById('modalTotal').innerText = selectedOrder.total_price + ' ‡∏ø';
        
        const list = document.getElementById('billItems');
        const printList = document.getElementById('printItems');
        list.innerHTML = '';
        printList.innerHTML = '';

        selectedOrder.items.forEach(i => {
            // Display UI
            list.innerHTML += `
                <div class="d-flex justify-content-between border-bottom py-2">
                    <span>${i.name} <small class="text-muted">${i.option||''}</small></span>
                    <b>${i.price}</b>
                </div>`;
            
            // Print UI
            printList.innerHTML += `
                <div style="display:flex; justify-content:space-between;">
                    <span>${i.name} ${i.option ? '('+i.option+')' : ''}</span>
                    <span>${i.price}</span>
                </div>`;
        });
        
        document.getElementById('printTotal').innerText = selectedOrder.total_price + ' ‡∏ø';

        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    async function checkBin() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô?')) return;
        await db.from('orders').update({status: 'paid'}).eq('id', selectedOrder.id);
        bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
        Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }

    async function cancelOrder() {
        if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
        await db.from('orders').delete().eq('id', selectedOrder.id);
        bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
    }

    function printBill() {
        const content = document.getElementById('receiptArea').innerHTML;
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå
        const win = window.open('', '', 'height=600,width=400');
        win.document.write('<html><head><title>Receipt</title>');
        win.document.write('</head><body >');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    function switchTab(tab) {
        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('d-none'));
        document.getElementById('view-'+tab).classList.remove('d-none');
    }
</script>
</body>
</html>
