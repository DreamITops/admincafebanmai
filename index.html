<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; padding: 20px; z-index: 100; transition: all 0.3s ease; }
        .main { margin-left: 260px; padding: 30px; transition: all 0.3s ease; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #ccc; display: flex; align-items: center; gap: 15px; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; font-weight: bold; }
        .nav-item i { min-width: 20px; text-align: center; }
        .table-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6; background: #eee; }
        .img-preview-box { width: 160px; height: 160px; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto; background: #fff; cursor: pointer; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .menu-selector-btn { text-align: left; padding: 10px; border: 1px solid #dee2e6; background: white; border-radius: 10px; width: 100%; margin-bottom: 5px; }
        @media(max-width: 992px) { .sidebar { display: none; } .main { margin-left: 0; padding: 15px; } }
    </style>
</head>
<body>

<div class="sidebar d-none d-lg-block">
    <div class="mb-4 ps-2">
        <h4 class="text-warning fw-bold"><i class="fas fa-utensils"></i> Admin Panel</h4>
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-home"></i> <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></div>
    <div class="nav-item" onclick="switchTab('menu', this)"><i class="fas fa-book"></i> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</span></div>
    <div class="nav-item" onclick="switchTab('report', this)"><i class="fas fa-chart-line"></i> <span>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span></div>
    <div class="nav-item mt-5 text-danger" onclick="location.reload()"><i class="fas fa-sync"></i> <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</span></div>
</div>

<div class="main">
    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-6"><div class="card p-3 border-start border-4 border-primary shadow-sm"><h3><span id="activeTables">0</span></h3><small class="text-muted">‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</small></div></div>
            <div class="col-6"><div class="card p-3 border-start border-4 border-success shadow-sm"><h3><span id="pendingSales">0</span></h3><small class="text-muted">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</small></div></div>
        </div>
        <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
        <div id="orderGrid" class="row"></div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
            <button class="btn btn-primary" onclick="openMenuModal()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div class="table-responsive bg-white rounded shadow-sm p-3">
            <table class="table align-middle">
                <thead class="table-light"><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="menuTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="view-report" class="d-none">
        <h3 class="mb-4">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
        <div class="card p-4 mb-3 bg-light border-0 shadow-sm"><div class="row text-center">
            <div class="col-6"><h6>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h6><h2 id="reportTotalSales" class="text-success fw-bold">0 ‡∏ø</h2></div>
            <div class="col-6"><h6>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6><h2 id="reportTotalOrders" class="text-primary fw-bold">0</h2></div>
        </div></div>
        <div id="reportContent" class="bg-white rounded p-3 shadow-sm"></div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <form id="menuForm">
            <input type="hidden" id="editMenuId">
            <input type="hidden" id="menuExistingUrl">
            <div class="mb-3">
                <label class="img-preview-box" for="menuImageFile">
                    <img id="previewImg" src="https://placehold.co/150x150?text=‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" alt="Preview">
                    <input type="file" id="menuImageFile" accept="image/*" hidden onchange="previewImage(event)">
                </label>
            </div>
            <input type="text" id="menuName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" required>
            <div class="row g-2 mb-3">
                <div class="col-6"><input type="number" id="menuPrice" class="form-control" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required></div>
                <div class="col-6">
                    <select id="menuCategory" class="form-select">
                        <option value="‡∏™‡πÄ‡∏ï‡πá‡∏Å">‡∏™‡πÄ‡∏ï‡πá‡∏Å</option><option value="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå</option>
                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                    </select>
                </div>
            </div>
            <div id="toppingContainer" class="p-2 bg-light rounded mb-2"></div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addToppingInput()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </form>
    </div>
    <div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div></div>

<div class="modal fade" id="billModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5>‡∏ö‡∏¥‡∏•‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <table class="table table-sm"><tbody id="billItemsDisplay"></tbody></table>
        <h4 class="text-end fw-bold">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="modalTotal" class="text-primary"></span></h4>
    </div>
    <div class="modal-footer"><button class="btn btn-success w-100 py-2 fw-bold" onclick="checkBin()">üí∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button></div>
</div></div></div>

<script>
    // !!! ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏à‡∏≤‡∏Å Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ !!!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRpU3n5WTVFM70grPzsaJVIeZ9HW3-PpE_RgQF2ZiMPqADa7BYZrqUjs6e3hIo84Ms/exec';

    let allMenus = [];
    let currentOrders = [];
    let selectedOrder = null;

    fetchOrders(); 
    setInterval(fetchOrders, 7000);

    function switchTab(view, btn) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('d-none'));
        document.getElementById('view-'+view).classList.remove('d-none');
        if(btn) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
        }
        if(view === 'menu') fetchMenu();
        if(view === 'report') renderReport();
    }

    async function apiRequest(params, method = 'GET') {
        let url = SCRIPT_URL;
        let options = { method: method };
        if (method === 'GET') url += `?${new URLSearchParams(params).toString()}`;
        else options.body = JSON.stringify(params);
        return await fetch(url, options).then(res => res.json());
    }

    async function fetchOrders() {
        const data = await apiRequest({ action: 'getOrders' });
        if(!data || data.error) return;
        currentOrders = data.filter(o => o.status !== 'paid').sort((a,b) => b.id - a.id);
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';
        document.getElementById('activeTables').innerText = currentOrders.length;
        document.getElementById('pendingSales').innerText = currentOrders.reduce((s,o)=>s+o.total_price,0).toLocaleString() + " ‡∏ø";
        
        currentOrders.forEach(o => {
            grid.innerHTML += `
                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm border-start border-4 border-warning p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5>
                            <span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <hr class="my-2">
                        <div class="small text-muted mb-2">${o.items.map(i => i.name + ' x' + i.qty).join(', ')}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="m-0 text-primary fw-bold">${o.total_price.toLocaleString()} ‡∏ø</h5>
                            <button class="btn btn-dark btn-sm" onclick="openBill(${o.id})">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    function openBill(id) {
        selectedOrder = currentOrders.find(o => String(o.id) === String(id));
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        document.getElementById('modalTotal').innerText = selectedOrder.total_price.toLocaleString() + " ‡∏ø";
        document.getElementById('billItemsDisplay').innerHTML = selectedOrder.items.map(i => 
            `<tr><td>${i.name}</td><td>x${i.qty}</td><td class="text-end">${i.price.toLocaleString()}</td></tr>`).join('');
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    /**
     * ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏ö UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Order Loop
     */
    async function checkBin() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß?')) return;
        const id = selectedOrder.id;
        bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        await apiRequest({ action: 'updateStatus', id: id, status: 'paid' }, 'POST');
        
        // Optimistic Update: ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        currentOrders = currentOrders.filter(o => String(o.id) !== String(id));
        renderDashboard();
        Swal.fire({icon:'success', title:'‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer:1000, showConfirmButton:false});
    }

    async function fetchMenu() {
        const data = await apiRequest({ action: 'getMenu' });
        allMenus = data;
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = data.map(m => `
            <tr>
                <td><img src="${m.image_url || 'https://placehold.co/80x80?text=No+Img'}" class="table-img" onerror="this.src='https://placehold.co/80x80?text=Error'"></td>
                <td><div class="fw-bold">${m.name}</div></td>
                <td>${m.price} ‡∏ø</td>
                <td><span class="badge bg-light text-dark border">${m.category}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editMenu(${m.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');
    }

    function previewImage(e) { 
        if(e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => document.getElementById('previewImg').src = evt.target.result;
            reader.readAsDataURL(e.target.files[0]);
        }
    }

    function openMenuModal() {
        document.getElementById('menuForm').reset();
        document.getElementById('editMenuId').value = "";
        document.getElementById('previewImg').src = 'https://placehold.co/150x150?text=‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
        document.getElementById('toppingContainer').innerHTML = "";
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    async function saveMenu() {
        const id = document.getElementById('editMenuId').value;
        const payload = {
            action: id ? 'editMenu' : 'addMenu',
            id: id,
            name: document.getElementById('menuName').value,
            price: parseInt(document.getElementById('menuPrice').value),
            category: document.getElementById('menuCategory').value,
            image_url: document.getElementById('menuExistingUrl').value,
            options: [] // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Toppings ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
        };

        const fileInput = document.getElementById('menuImageFile');
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            payload.image_data = await new Promise(res => {
                const r = new FileReader(); r.onload = e => res(e.target.result); r.readAsDataURL(file);
            });
            payload.image_name = file.name;
        }

        Swal.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen:()=>Swal.showLoading()});
        await apiRequest(payload, 'POST');
        Swal.close();
        bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
        fetchMenu();
    }

    async function deleteMenu(id) {
        if(!confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) return;
        Swal.fire({title:'‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π...', didOpen:()=>Swal.showLoading()});
        await apiRequest({action: 'deleteMenu', id: id}, 'POST');
        Swal.close();
        fetchMenu();
    }

    async function renderReport() {
        const data = await apiRequest({ action: 'getOrders' });
        const paid = data.filter(o => o.status === 'paid');
        document.getElementById('reportTotalSales').innerText = paid.reduce((s,o)=>s+o.total_price,0).toLocaleString() + " ‡∏ø";
        document.getElementById('reportTotalOrders').innerText = paid.length;
        
        let html = '<table class="table table-sm"><thead><tr><th>‡∏ß‡∏±‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th>‡∏ö‡∏¥‡∏•</th></tr></thead><tbody>';
        const summary = {};
        paid.forEach(o => {
            const date = new Date(o.created_at || o.id).toLocaleDateString('th-TH');
            if(!summary[date]) summary[date] = {total: 0, count: 0};
            summary[date].total += o.total_price;
            summary[date].count++;
        });
        for(let d in summary) {
            html += `<tr><td>${d}</td><td>${summary[d].total.toLocaleString()}</td><td>${summary[d].count}</td></tr>`;
        }
        document.getElementById('reportContent').innerHTML = html + '</tbody></table>';
    }
</script>
</body>
</html>
