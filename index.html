<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <ul class="nav nav-pills mb-3" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" onclick="showTab('orders')">üë®‚Äçüç≥ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏Ñ‡∏£‡∏±‡∏ß)</button></li>
            <li class="nav-item"><button class="nav-link" onclick="showTab('menu')">üìñ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</button></li>
        </ul>

        <div id="orders-tab">
            <button class="btn btn-primary mb-3" onclick="loadOrders()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <div class="row" id="order-list"></div>
        </div>

        <div id="menu-tab" style="display:none;">
            <div class="card p-4">
                <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h4>
                <input type="file" id="menuImg" class="form-control mb-2" accept="image/*">
                <input type="text" id="menuName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                <input type="number" id="menuPrice" class="form-control mb-2" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                <input type="text" id="menuCategory" class="form-control mb-2" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡πâ‡∏°, ‡∏ú‡∏±‡∏î)">
                <button class="btn btn-success w-100" onclick="uploadAndAddMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏ô‡∏π</button>
            </div>
            <hr>
            <table class="table table-bordered bg-white mt-3">
                <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏•‡∏ö</th></tr></thead>
                <tbody id="menu-table"></tbody>
            </table>
        </div>
    </div>

<script>
    // üî¥ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = 'https://script.google.com/macros/s/AKfycbwtYK7lOXkqhdmgJvlbZIQKZj9MxulxPrFi9DKIu5jgpkA7Psood1I5Zv9Nu-wsg-4ing/exec'; 

    function showTab(tab) {
        document.getElementById('orders-tab').style.display = tab==='orders'?'block':'none';
        document.getElementById('menu-tab').style.display = tab==='menu'?'block':'none';
        if(tab==='orders') loadOrders();
        if(tab==='menu') loadMenu();
    }

    async function loadOrders() {
        const res = await fetch(API_URL + '?action=getActiveOrders');
        const data = await res.json();
        const div = document.getElementById('order-list');
        div.innerHTML = data.length ? data.map(o => {
            const items = JSON.parse(o.items).map(i => `<li>${i.name} x${i.qty}</li>`).join('');
            let btn = `<button class="btn btn-warning btn-sm" onclick="setStatus('${o.id}','cooking')">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>`;
            if(o.status==='cooking') btn = `<button class="btn btn-success btn-sm" onclick="setStatus('${o.id}','served')">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>`;
            if(o.status==='served') btn = `<button class="btn btn-secondary btn-sm" onclick="setStatus('${o.id}','paid')">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>`;
            return `<div class="col-md-4 mb-3"><div class="card p-3 shadow-sm">
                <h5>‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no} <span class="badge bg-info">${o.queue_no}</span></h5>
                <ul>${items}</ul>
                <div class="text-end fw-bold text-danger">${o.total_price} ‡∏ö.</div>
                <div class="mt-2 text-center">${btn}</div>
            </div></div>`;
        }).join('') : '<p class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</p>';
    }

    function setStatus(id, status) {
        fetch(API_URL, { method:'POST', body:JSON.stringify({action:'updateStatus', order_id:id, status:status}) })
        .then(() => loadOrders());
    }

    async function loadMenu() {
        const res = await fetch(API_URL + '?action=getMenu');
        const data = await res.json();
        document.getElementById('menu-table').innerHTML = data.map(m => 
            `<tr>
                <td><img src="${m.image_url}" width="50"></td>
                <td>${m.name}</td><td>${m.price}</td>
                <td><button class="btn btn-danger btn-sm" onclick="delMenu('${m.id}')">‡∏•‡∏ö</button></td>
            </tr>`).join('');
    }

    function uploadAndAddMenu() {
        const file = document.getElementById('menuImg').files[0];
        const name = document.getElementById('menuName').value;
        const price = document.getElementById('menuPrice').value;
        const cat = document.getElementById('menuCategory').value;
        
        if(!name || !price) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        
        Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});

        if(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const base64 = e.target.result.split(',')[1];
                fetch(API_URL, { method:'POST', body:JSON.stringify({
                    action:'uploadImage', fileData:base64, fileName:file.name, mimeType:file.type
                })}).then(r=>r.json()).then(d => {
                    if(d.result==='success') saveMenu(name, price, cat, d.url);
                    else Swal.fire('Error', d.error, 'error');
                });
            };
        } else {
            saveMenu(name, price, cat, '');
        }
    }

    function saveMenu(name, price, cat, url) {
        fetch(API_URL, { method:'POST', body:JSON.stringify({
            action:'addMenu', name:name, price:price, category:cat, image_url:url
        })}).then(() => { Swal.close(); loadMenu(); document.getElementById('menuName').value=''; });
    }

    function delMenu(id) {
        if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) fetch(API_URL, { method:'POST', body:JSON.stringify({action:'deleteMenu', id:id}) }).then(()=>loadMenu());
    }

    loadOrders(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
</script>
</body>
</html>

