<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #eef2f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar & Layout */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; padding: 20px; z-index: 100; overflow-y: auto; }
        .main { margin-left: 260px; padding: 30px; }
        
        .nav-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #b0b8c1; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; }
        
        /* Dashboard Elements */
        .order-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; border-left: 5px solid #f1c40f; transition: 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .order-card.cooking { border-left-color: #e67e22; }
        .order-card.served { border-left-color: #27ae60; }
        
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: space-between; }
        
        @media(max-width: 992px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; }
            .main { margin-left: 0; }
            .show-sidebar .sidebar { transform: translateX(0); }
        }

        /* Print CSS */
        @media print {
            body * { visibility: hidden; }
            #receiptArea, #receiptArea * { visibility: visible; }
            #receiptArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h4 class="mb-4 ps-2 fw-bold text-warning"><i class="fas fa-utensils"></i> RestoPro</h4>
    
    <div class="nav-item active" onclick="switchTab('dashboard', this)">
        <i class="fas fa-th-large"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô
    </div>
    <div class="nav-item" onclick="switchTab('menu', this)">
        <i class="fas fa-book-open"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π
    </div>
    
    <div class="nav-item mt-5 text-danger" onclick="location.reload()">
        <i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö
    </div>
</div>

<div class="main">
    <button class="btn btn-dark d-lg-none mb-3" onclick="document.body.classList.toggle('show-sidebar')"><i class="fas fa-bars"></i> ‡πÄ‡∏°‡∏ô‡∏π</button>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted mb-1">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</h6>
                        <h2 class="fw-bold text-primary mb-0" id="activeTables">0</h2>
                    </div>
                    <i class="fas fa-chair fa-2x text-primary opacity-25"></i>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</h6>
                        <h2 class="fw-bold text-success mb-0" id="pendingSales">0 ‡∏ø</h2>
                    </div>
                    <i class="fas fa-coins fa-2x text-success opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0"><i class="fas fa-clipboard-list"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="fetchOrders()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        </div>
        
        <div class="row" id="orderGrid">
            <div class="col-12 text-center py-5">Loading...</div>
        </div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold"><i class="fas fa-hamburger"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
            <button class="btn btn-primary" onclick="addMenu()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="menuTableBody">
                        <tr><td colspan="5" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="billItemsDisplay" class="mb-3"></div>
                <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                    <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                    <span class="text-primary" id="modalTotal">0 ‡∏ø</span>
                </div>

                <div id="receiptArea" class="d-none bg-white p-2 text-center" style="width: 300px; font-family: monospace;">
                    <h3 class="fw-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <p>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢ Pro</p>
                    <hr style="border-top: 1px dashed black;">
                    <div id="printItems" class="text-start" style="font-size: 0.9rem;"></div>
                    <hr style="border-top: 1px dashed black;">
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>TOTAL</span>
                        <span id="printTotal">0</span>
                    </div>
                    <p class="mt-3 small">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                    <p class="small text-muted" id="printDate"></p>
                </div>
            </div>
            <div class="modal-footer flex-column">
                <div class="d-flex gap-2 w-100">
                    <button class="btn btn-outline-dark flex-grow-1" onclick="printBill()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    <button class="btn btn-success flex-grow-1 py-2 fw-bold" onclick="checkBin()"><i class="fas fa-check-circle"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button>
                </div>
                <button class="btn btn-link text-secondary btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentOrders = [];
    let selectedOrder = null;

    // --- Init ---
    fetchOrders(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    
    // Realtime Updates
    db.channel('admin-dashboard').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, 
        () => fetchOrders()
    ).subscribe();

    // --- Tab Switching ---
    function switchTab(viewId, btnElement) {
        // Hide all views
        document.getElementById('view-dashboard').classList.add('d-none');
        document.getElementById('view-menu').classList.add('d-none');
        
        // Show selected view
        document.getElementById('view-' + viewId).classList.remove('d-none');
        
        // Update Sidebar Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        // Load data specific to view
        if(viewId === 'menu') fetchMenu();
        if(viewId === 'dashboard') fetchOrders();
    }

    // ================= DASHBOARD LOGIC =================

    async function fetchOrders() {
        // ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢
        const { data, error } = await db.from('orders')
            .select('*')
            .neq('status', 'paid')
            .order('updated_at', { ascending: false });

        if(error) return console.error(error);
        currentOrders = data;
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';

        // Update Stats
        document.getElementById('activeTables').innerText = currentOrders.length;
        const totalPending = currentOrders.reduce((sum, o) => sum + o.total_price, 0);
        document.getElementById('pendingSales').innerText = totalPending.toLocaleString() + ' ‡∏ø';
        
        if(currentOrders.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4><p>‡∏£‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤...</p></div>';
            return;
        }

        currentOrders.forEach(o => {
            let statusBadge = '';
            let actionBtn = '';

            // Logic Status Flow
            if(o.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏ó‡∏≥</span>';
                actionBtn = `<button class="btn btn-outline-warning w-100 mb-2 btn-sm fw-bold" onclick="updateStatus(${o.id}, 'cooking')">üî• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∏‡∏á</button>`;
            } else if(o.status === 'cooking') {
                statusBadge = '<span class="badge bg-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á</span>';
                actionBtn = `<button class="btn btn-success w-100 mb-2 btn-sm fw-bold" onclick="updateStatus(${o.id}, 'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</button>`;
            } else {
                statusBadge = '<span class="badge bg-success">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏Ñ‡∏£‡∏ö</span>';
            }

            const itemCount = o.items.length;
            
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="order-card p-3 ${o.status}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="fw-bold m-0">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5>
                            ${statusBadge}
                        </div>
                        <div class="text-muted small mb-2"><i class="far fa-clock"></i> ${new Date(o.created_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})} ‚Ä¢ ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        
                        <div class="bg-light p-2 rounded mb-3 border" style="max-height: 120px; overflow-y: auto;">
                            ${o.items.map(i => `<div class="small text-truncate">- ${i.name} ${i.option ? '<span class="text-primary">('+i.option+')</span>' : ''}</div>`).join('')}
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">‡∏£‡∏ß‡∏°</span>
                            <h4 class="fw-bold text-primary m-0">${o.total_price} ‡∏ø</h4>
                        </div>
                        
                        ${actionBtn}
                        <button class="btn btn-dark w-100 btn-sm" onclick="openBill(${o.id})"><i class="fas fa-receipt"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</button>
                    </div>
                </div>`;
        });
    }

    async function updateStatus(id, status) {
        await db.from('orders').update({status}).eq('id', id);
        fetchOrders();
    }

    // --- Bill & Print Logic ---
    function openBill(id) {
        selectedOrder = currentOrders.find(o => o.id === id);
        
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        document.getElementById('modalTotal').innerText = selectedOrder.total_price + ' ‡∏ø';
        document.getElementById('printDate').innerText = new Date().toLocaleString('th-TH');

        const displayList = document.getElementById('billItemsDisplay');
        const printList = document.getElementById('printItems');
        
        displayList.innerHTML = '';
        printList.innerHTML = '';

        selectedOrder.items.forEach(i => {
            const opt = i.option ? `(${i.option})` : '';
            const note = i.note ? `<br><small class="text-danger">*${i.note}</small>` : '';
            
            // ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            displayList.innerHTML += `
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <span>${i.name} <small class="text-primary">${opt}</small></span>
                        ${note}
                    </div>
                    <span class="fw-bold">${i.price}</span>
                </div>`;
            
            // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢)
            printList.innerHTML += `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${i.name} ${opt}</span>
                    <span>${i.price}</span>
                </div>`;
        });

        document.getElementById('printTotal').innerText = selectedOrder.total_price;
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    async function checkBin() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞?')) return;
        await db.from('orders').update({ status: 'paid' }).eq('id', selectedOrder.id);
        bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        fetchOrders();
    }

    function printBill() {
        const content = document.getElementById('receiptArea').innerHTML;
        const win = window.open('', '', 'height=600,width=400');
        win.document.write('<html><head><title>Print Bill</title>');
        win.document.write('</head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        setTimeout(() => win.print(), 500);
    }

    // ================= MENU MANAGER LOGIC =================

    async function fetchMenu() {
        const { data, error } = await db.from('menu_items').select('*').order('id');
        if(error) return console.error(error);
        
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        
        data.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td><span class="badge bg-light text-dark border">${m.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</span></td>
                    <td>
                        ${m.is_available 
                            ? '<span class="badge bg-success">‡∏Ç‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà</span>' 
                            : '<span class="badge bg-secondary">‡∏´‡∏°‡∏î</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning" onclick="toggleMenu(${m.id}, ${!m.is_available})">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    async function addMenu() {
        const { value: formValues } = await Swal.fire({
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà',
            html:
                '<input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π">' +
                '<input id="swal-price" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">' +
                '<select id="swal-cat" class="swal2-input">' +
                    '<option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>' +
                    '<option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>' +
                    '<option value="‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô">‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</option>' +
                '</select>',
            focusConfirm: false,
            preConfirm: () => {
                return [
                    document.getElementById('swal-name').value,
                    document.getElementById('swal-price').value,
                    document.getElementById('swal-cat').value
                ]
            }
        });

        if (formValues && formValues[0]) {
            const name = formValues[0];
            const price = parseInt(formValues[1]);
            const category = formValues[2];
            
            // Default Options logic (Auto assign hot/cold for drinks if needed)
            let options = [];
            if(category === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°') {
                 options = [
                     {"name":"‡∏£‡πâ‡∏≠‡∏ô", "price":0}, 
                     {"name":"‡πÄ‡∏¢‡πá‡∏ô", "price":5}, 
                     {"name":"‡∏õ‡∏±‡πà‡∏ô", "price":10}
                 ];
            }

            const { error } = await db.from('menu_items').insert([{ 
                name, price, category, options 
            }]);
            
            if(error) Swal.fire('Error', error.message, 'error');
            else {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡πâ‡∏ß', 'success');
                fetchMenu();
            }
        }
    }

    async function toggleMenu(id, status) {
        await db.from('menu_items').update({ is_available: status }).eq('id', id);
        fetchMenu();
    }

    async function deleteMenu(id) {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π?')) {
            await db.from('menu_items').delete().eq('id', id);
            fetchMenu();
        }
    }

</script>
</body>
</html>
