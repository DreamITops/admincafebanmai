<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banmai Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; }
        .sidebar { width: 250px; position: fixed; top: 0; bottom: 0; left: 0; background: #343a40; color: white; padding: 20px; z-index: 1000; }
        .main-content { margin-left: 250px; padding: 20px; }
        .nav-link { color: #cfd2d6; cursor: pointer; margin-bottom: 5px; border-radius: 5px; }
        .nav-link:hover, .nav-link.active { background: #0d6efd; color: white; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .order-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-pending { border-left-color: #ffc107; }
        .status-cooking { border-left-color: #0d6efd; }
        .status-served { border-left-color: #198754; }
        
        @media(max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h3 class="fw-bold mb-4 px-2"><i class="fas fa-coffee"></i> Banmai Admin</h3>
    <div class="nav-link active" onclick="showPage('dashboard', this)"><i class="fas fa-home me-2"></i> แดชบอร์ด & ออเดอร์</div>
    <div class="nav-link" onclick="showPage('menu', this)"><i class="fas fa-utensils me-2"></i> จัดการเมนู</div>
    <div class="nav-link" onclick="showPage('report', this)"><i class="fas fa-chart-line me-2"></i> สรุปยอดขาย</div>
</div>

<button class="btn btn-dark d-md-none position-fixed top-0 end-0 m-3 z-3" onclick="document.getElementById('sidebar').classList.toggle('show')"><i class="fas fa-bars"></i></button>

<div class="main-content">
    
    <div id="page-dashboard">
        <h4 class="fw-bold mb-3">รายการออเดอร์ล่าสุด</h4>
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card card-stat p-3 bg-warning bg-opacity-10 text-warning border-warning border-start border-4">
                    <h5>รอปรุง</h5>
                    <h2 class="fw-bold" id="countPending">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-stat p-3 bg-success bg-opacity-10 text-success border-success border-start border-4">
                    <h5>ยอดขายวันนี้</h5>
                    <h2 class="fw-bold" id="sumToday">0 ฿</h2>
                </div>
            </div>
        </div>

        <button class="btn btn-primary mb-3" onclick="loadOrders()"><i class="fas fa-sync"></i> รีเฟรชออเดอร์</button>
        <div id="orderListArea">กำลังโหลด...</div>
    </div>

    <div id="page-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>จัดการเมนูอาหาร</h4>
            <button class="btn btn-success" onclick="openMenuModal()">+ เพิ่มเมนู</button>
        </div>
        <div class="card card-stat p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead><tr><th>รูป</th><th>ชื่อ</th><th>ราคา</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
                    <tbody id="menuTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="page-report" class="d-none">
        <h4>สรุปยอดขาย</h4>
        <div class="card card-stat p-4">
            <canvas id="salesChart" style="max-height: 400px;"></canvas>
        </div>
    </div>

</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ข้อมูลเมนู</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="menuId">
                <div class="mb-2"><label>ชื่อเมนู</label><input type="text" id="menuName" class="form-control"></div>
                <div class="mb-2"><label>ราคา</label><input type="number" id="menuPrice" class="form-control"></div>
                <div class="mb-2"><label>หมวดหมู่</label><input type="text" id="menuCategory" class="form-control"></div>
                <div class="mb-2"><label>รูปภาพ (เลือกไฟล์)</label><input type="file" id="menuFile" class="form-control" onchange="convertBase64()"></div>
                <input type="hidden" id="menuBase64">
                <input type="hidden" id="menuFileName">
                
                <div class="mb-2 border p-2 rounded bg-light">
                    <label>Options (เช่น ธรรมดา:0, พิเศษ:10)</label>
                    <textarea id="menuOptions" class="form-control" rows="3" placeholder='[{"name":"ไข่ดาว","price":10}]'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" onclick="saveMenu()">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // ใส่ URL เดิมของคุณที่นี่
    // ==========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz6tXDr5aHNDsn9mlbglnKHSnqsgixeKObMbGWxlVRXGOzJpRrtJp7AUX-P3WprVMBH/exec';

    // --- ฟังก์ชันจัดการแท็บ ---
    function showPage(pageId, el) {
        document.querySelectorAll('.main-content > div').forEach(d => d.classList.add('d-none'));
        document.getElementById('page-' + pageId).classList.remove('d-none');
        document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
        if(pageId === 'report') renderChart();
    }

    // --- ส่วนออเดอร์ (Logic เดิม) ---
    function loadOrders() {
        fetch(SCRIPT_URL + '?action=getOrders')
            .then(res => res.json())
            .then(data => {
                renderOrders(data);
                renderStats(data);
                window.allOrdersData = data; // เก็บไว้ทำกราฟ
            });
    }

    function renderOrders(orders) {
        // เรียงลำดับ ล่าสุดขึ้นก่อน
        orders.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
        
        const html = orders.map(o => {
            let statusClass = 'status-pending';
            let statusText = 'รอคิว';
            if(o.status === 'cooking') { statusClass = 'status-cooking'; statusText = 'กำลังทำ'; }
            if(o.status === 'served') { statusClass = 'status-served'; statusText = 'เสิร์ฟแล้ว'; }
            if(o.status === 'paid') return ''; // ซ่อนที่จ่ายเงินแล้ว (หรือจะแสดงก็ได้)

            // แปลงรายการอาหาร JSON
            let itemsHtml = '';
            try {
                const items = JSON.parse(o.items);
                itemsHtml = items.map(i => `<div>- ${i.name} x${i.qty} <small class="text-muted">(${i.options||''})</small></div>`).join('');
            } catch(e) { itemsHtml = 'Items error'; }

            return `
            <div class="order-card ${statusClass}">
                <div class="d-flex justify-content-between">
                    <h5 class="fw-bold">โต๊ะ ${o.table_no}</h5>
                    <span class="badge bg-secondary">${new Date(o.created_at).toLocaleTimeString()}</span>
                </div>
                <div class="mb-2">${itemsHtml}</div>
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="text-danger fw-bold m-0">${o.total_price} ฿</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="updateStatus(${o.id}, 'cooking')">ทำ</button>
                        <button class="btn btn-outline-success btn-sm" onclick="updateStatus(${o.id}, 'served')">เสิร์ฟ</button>
                        <button class="btn btn-outline-dark btn-sm" onclick="updateStatus(${o.id}, 'paid')">เก็บเงิน</button>
                    </div>
                </div>
                <div class="mt-2 text-end"><small class="badge bg-light text-dark border">${statusText}</small></div>
            </div>`;
        }).join('');

        document.getElementById('orderListArea').innerHTML = html || '<p class="text-muted text-center">ไม่มีออเดอร์ค้าง</p>';
    }

    function updateStatus(id, status) {
        Swal.fire({title: 'กำลังบันทึก...', didOpen:()=>Swal.showLoading()});
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'updateStatus', id: id, status: status })
        }).then(() => {
            Swal.close();
            loadOrders();
        });
    }

    function renderStats(orders) {
        const pending = orders.filter(o => o.status === 'pending').length;
        // หาบิลที่ paid วันนี้
        const todayStr = new Date().toDateString();
        const sales = orders.filter(o => o.status === 'paid' && new Date(o.created_at).toDateString() === todayStr)
                            .reduce((sum, o) => sum + o.total_price, 0);
        
        document.getElementById('countPending').innerText = pending;
        document.getElementById('sumToday').innerText = sales.toLocaleString() + ' ฿';
    }

    // --- ส่วนเมนู (Logic เดิม) ---
    function loadMenu() {
        fetch(SCRIPT_URL + '?action=getMenu').then(res=>res.json()).then(data => {
            const html = data.map(m => `
                <tr>
                    <td><img src="${m.image_url}" width="50" height="50" class="rounded"></td>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td><span class="badge bg-${m.is_available?'success':'secondary'}">${m.is_available?'ขาย':'หมด'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenu(${m.id})">ลบ</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('menuTable').innerHTML = html;
        });
    }

    function openMenuModal() {
        document.getElementById('menuId').value = ''; 
        document.getElementById('menuName').value = '';
        document.getElementById('menuPrice').value = '';
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function convertBase64() {
        const file = document.getElementById('menuFile').files[0];
        const reader = new FileReader();
        reader.onloadend = function() {
            document.getElementById('menuBase64').value = reader.result;
            document.getElementById('menuFileName').value = file.name;
        }
        reader.readAsDataURL(file);
    }

    function saveMenu() {
        const payload = {
            action: 'addMenu',
            name: document.getElementById('menuName').value,
            price: document.getElementById('menuPrice').value,
            category: document.getElementById('menuCategory').value,
            image_data: document.getElementById('menuBase64').value,
            image_name: document.getElementById('menuFileName').value,
            options: JSON.parse(document.getElementById('menuOptions').value || '[]')
        };
        Swal.fire('กำลังบันทึก...', '', 'info');
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => {
                Swal.fire('สำเร็จ', '', 'success');
                loadMenu();
                bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            });
    }
    
    function deleteMenu(id) {
        if(!confirm('ลบเมนูนี้?')) return;
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'deleteMenu', id:id}) })
            .then(()=>loadMenu());
    }

    // --- ส่วนกราฟ (ใหม่!) ---
    let myChart;
    function renderChart() {
        if(!window.allOrdersData) return;
        const paid = window.allOrdersData.filter(o => o.status === 'paid');
        const sales = {}; 
        paid.forEach(o => {
            const d = new Date(o.created_at).toLocaleDateString('th-TH');
            sales[d] = (sales[d]||0) + o.total_price;
        });

        const ctx = document.getElementById('salesChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(sales),
                datasets: [{ label: 'ยอดขาย (บาท)', data: Object.values(sales), backgroundColor: '#0d6efd' }]
            }
        });
    }

    // เริ่มทำงาน
    loadOrders();
    loadMenu();
    setInterval(loadOrders, 10000); // รีเฟรชออเดอร์ทุก 10 วิ

</script>
</body>
</html>
