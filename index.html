<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - Admin (Auto Detect)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; padding: 20px; z-index: 100; transition: all 0.3s ease; overflow-x: hidden; }
        .main { margin-left: 260px; padding: 30px; transition: all 0.3s ease; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #ccc; display: flex; align-items: center; gap: 15px; white-space: nowrap; overflow: hidden; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; font-weight: bold; }
        .nav-item i { min-width: 20px; text-align: center; font-size: 1.1rem; }

        /* Mobile / Mini Sidebar */
        body.sidebar-mini .sidebar { width: 80px; padding: 20px 10px; }
        body.sidebar-mini .main { margin-left: 80px; }
        body.sidebar-mini .nav-text, body.sidebar-mini .sidebar-header-text { display: none; }
        body.sidebar-mini .nav-item { justify-content: center; }

        /* Image Upload Box */
        .img-preview-box { width: 150px; height: 150px; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; margin: 0 auto; background: #f9f9f9;}
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        /* Progress Bar for Report */
        .bar-container { height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; background: #28a745; transition: width 0.5s; }

        /* Bill Menu Selector */
        .menu-selector-btn { text-align: left; white-space: normal; height: auto; padding: 8px; border: 1px solid #dee2e6; background: white; transition: 0.2s; }
        .menu-selector-btn:hover { border-color: #0d6efd; background: #f8f9fa; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        @media(max-width: 992px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

<div class="sidebar d-none d-lg-block">
    <div class="d-flex align-items-center justify-content-between mb-4 ps-2">
        <h4 class="m-0 text-warning fw-bold sidebar-header-text"><i class="fas fa-utensils"></i> Admin</h4>
        <button class="btn btn-sm btn-outline-secondary text-white border-0" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-home"></i> <span class="nav-text">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></div>
    <div class="nav-item" onclick="switchTab('menu', this)"><i class="fas fa-book"></i> <span class="nav-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span></div>
    <div class="nav-item" onclick="switchTab('report', this)"><i class="fas fa-chart-line"></i> <span class="nav-text">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span></div>
    <div class="nav-item mt-5 text-danger" onclick="location.reload()"><i class="fas fa-sync"></i> <span class="nav-text">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</span></div>
</div>

<div class="main">
    <div class="d-lg-none mb-3 d-flex justify-content-between align-items-center">
        <h4 class="fw-bold m-0">Admin Pro</h4>
        <div>
            <button class="btn btn-outline-dark btn-sm me-1" onclick="switchTab('dashboard')"><i class="fas fa-home"></i></button>
            <button class="btn btn-outline-dark btn-sm" onclick="switchTab('menu')"><i class="fas fa-book"></i></button>
        </div>
    </div>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-6"><div class="card p-3 border-start border-4 border-primary"><h3><i class="fas fa-chair"></i> <span id="activeTables">0</span></h3><small>‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</small></div></div>
            <div class="col-6"><div class="card p-3 border-start border-4 border-success"><h3><i class="fas fa-coins"></i> <span id="pendingSales">0</span></h3><small>‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</small></div></div>
        </div>
        <h5 class="fw-bold"><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Live) <span class="spinner-grow spinner-grow-sm text-success" role="status"></span></h5>
        <div class="row" id="orderGrid"><div class="col-12 text-center py-5">Waiting for orders...</div></div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
            <button class="btn btn-primary" onclick="openMenuModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
        <div class="card shadow-sm"><div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light"><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="menuTableBody"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
            </table>
        </div></div>
    </div>

    <div id="view-report" class="d-none">
        <h3 class="mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h3>
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#daily" onclick="renderReport('daily')">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#monthly" onclick="renderReport('monthly')">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
        </ul>
        <div class="card p-3 mb-3 bg-light border-0">
            <div class="d-flex justify-content-between align-items-center">
                <div><h5 class="text-muted mb-0">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h5><h2 class="fw-bold text-success mb-0" id="reportTotalSales">0 ‡∏ø</h2></div>
                <div class="text-end"><h5 class="text-muted mb-0">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5><h3 class="fw-bold text-primary mb-0" id="reportTotalOrders">0</h3></div>
            </div>
        </div>
        <div id="reportContent" class="table-responsive bg-white rounded shadow-sm p-3"></div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="editMenuId">
                    <div class="mb-3 text-center">
                        <label class="img-preview-box" for="menuImageFile">
                            <img id="previewImg" src="https://via.placeholder.com/150?text=Upload" alt="Preview">
                            <input type="file" id="menuImageFile" accept="image/*" hidden onchange="previewImage(event)">
                        </label>
                        <small class="text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</small>
                    </div>
                    <input type="text" id="menuName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" required>
                    <div class="row mb-3">
                        <div class="col-6"><input type="number" id="menuPrice" class="form-control" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required></div>
                        <div class="col-6">
                            <select id="menuCategory" class="form-select">
                                <option value="‡∏™‡πÄ‡∏ï‡πá‡∏Å">‡∏™‡πÄ‡∏ï‡πá‡∏Å</option>
                                <option value="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå</option>
                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
                                <option value="‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô">‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</option>
                                <option value="‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                <option value="‡∏Å‡∏≤‡πÅ‡∏ü">‡∏Å‡∏≤‡πÅ‡∏ü</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="fw-bold">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏° (Toppings)</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addToppingInput()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div id="toppingContainer" class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="fas fa-receipt"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5 order-md-2 border-start">
                        <h6 class="fw-bold text-muted mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h6>
                        <div class="table-responsive border rounded" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm mb-0">
                                <thead class="table-light sticky-top"><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th width="100">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-end">‡∏£‡∏ß‡∏°</th></tr></thead>
                                <tbody id="billItemsDisplay"></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top bg-light p-3 rounded">
                            <h5 class="text-muted m-0">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h5>
                            <h3 class="text-primary fw-bold m-0" id="modalTotal">0 ‡∏ø</h3>
                        </div>
                        <button class="btn btn-success fw-bold w-100 mt-3 py-2" onclick="checkBin()">üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button>
                    </div>

                    <div class="col-md-7 order-md-1 mb-3">
                        <h6 class="fw-bold text-muted mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h6>
                        <div class="d-flex gap-2 overflow-auto pb-2 mb-2" id="billMenuCategories"></div>
                        <div class="row g-2" id="billMenuGrid" style="max-height: 450px; overflow-y: auto; align-content: flex-start;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Audio
    const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    // Global State
    let allMenus = [];
    let currentOrders = [];
    let selectedOrder = null;
    let currentBillCategory = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    let lastOrderCount = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchOrders();
        setupRealtime();

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (Polling Detection) ---
        // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á (Backup) ‡∏Å‡∏£‡∏ì‡∏µ Realtime ‡∏´‡∏•‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Internet ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
        setInterval(async () => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (count: 'exact', head: true ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
            const { count, error } = await db
                .from('orders')
                .select('*', { count: 'exact', head: true })
                .neq('status', 'paid');

            if (!error && count !== null) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
                if (count > lastOrderCount) {
                    console.log("New order detected via Polling!");
                    playNotification();
                    Swal.mixin({ 
                        toast: true, 
                        position: 'top-end', 
                        showConfirmButton: false, 
                        timer: 4000 
                    }).fire({ 
                        icon: 'success', 
                        title: `üîî ‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! (‡∏£‡∏ß‡∏° ${count} ‡πÇ‡∏ï‡πä‡∏∞)` 
                    });
                    fetchOrders(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                } 
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏î‡∏•‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ Sync ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                else if (count < lastOrderCount) {
                    fetchOrders();
                }
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                lastOrderCount = count;
            }
        }, 5000); // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    });

    function setupRealtime() {
        db.channel('admin-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
            if (payload.eventType === 'INSERT') {
                playNotification();
                Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'üîî ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà!' });
            }
            fetchOrders();
        })
        .subscribe();
    }

    function playNotification() { notificationSound.play().catch(e => console.log("Audio blocked:", e)); }
    function toggleSidebar() { document.body.classList.toggle('sidebar-mini'); }

    function switchTab(view, btn) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('d-none'));
        document.getElementById('view-'+view).classList.remove('d-none');
        if(btn && document.querySelector('.d-lg-block')) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }
        if(view === 'menu') fetchMenu();
        if(view === 'dashboard') fetchOrders();
        if(view === 'report') renderReport('daily');
    }

    // --- Dashboard Logic ---
    async function fetchOrders() {
        const { data, error } = await db.from('orders').select('*').neq('status', 'paid').order('created_at', {ascending:false}); 
        if(error) { console.error(error); return; }
        
        currentOrders = data || [];
        lastOrderCount = currentOrders.length; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        renderDashboard();
    }

    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';
        document.getElementById('activeTables').innerText = currentOrders.length;
        document.getElementById('pendingSales').innerText = currentOrders.reduce((a,b)=>a+b.total_price,0).toLocaleString();
        
        if(currentOrders.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏ß‡πà‡∏≤‡∏á)</div>'; return; }
        
        currentOrders.forEach(o => {
            let badge = o.status==='pending'?'bg-warning':(o.status==='cooking'?'bg-danger':'bg-success');
            let statusText = o.status==='pending'?'‡∏£‡∏≠‡∏ó‡∏≥':(o.status==='cooking'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥':'‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß');
            let actionBtn = o.status==='pending' 
                ? `<button class="btn btn-outline-warning w-100 btn-sm mb-2" onclick="setStatus(${o.id},'cooking')">üî• ‡∏õ‡∏£‡∏∏‡∏á</button>`
                : (o.status==='cooking' ? `<button class="btn btn-success w-100 btn-sm mb-2" onclick="setStatus(${o.id},'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>` : '');
            
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card p-3 mb-3 border-start border-4 border-${badge === 'bg-warning' ? 'warning' : (badge === 'bg-danger' ? 'danger' : 'success')}">
                        <div class="d-flex justify-content-between mb-2"><h5 class="m-0 fw-bold">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5><span class="badge ${badge}">${statusText}</span></div>
                        <div class="bg-light p-2 rounded mb-2 small" style="max-height:100px;overflow-y:auto">
                            ${o.items.map(i=> `<div>- ${i.name} ${i.option?`(${i.option})`:''} <span class="text-muted">x${i.qty||1}</span></div>`).join('')}
                        </div>
                        <h5 class="text-end fw-bold text-primary">${o.total_price.toLocaleString()} ‡∏ø</h5>
                        ${actionBtn}
                        <button class="btn btn-dark w-100 btn-sm" onclick="openBill(${o.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•</button>
                    </div>
                </div>`;
        });
    }

    async function setStatus(id, st) { await db.from('orders').update({status:st}).eq('id', id); fetchOrders(); }

    // --- Bill Logic ---
    async function openBill(id) {
        const { data } = await db.from('orders').select('*').eq('id', id).single();
        selectedOrder = data;
        if(allMenus.length === 0) await fetchMenu();
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        renderBillItems();
        renderBillCategories();
        renderBillMenuGrid('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    function renderBillCategories() {
        const definedCats = ['‡∏™‡πÄ‡∏ï‡πá‡∏Å', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß', '‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Å‡∏≤‡πÅ‡∏ü', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
        const cats = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', ...definedCats]; 
        const container = document.getElementById('billMenuCategories');
        container.innerHTML = '';
        cats.forEach(c => {
            const activeClass = c === currentBillCategory ? 'btn-primary' : 'btn-outline-secondary';
            container.innerHTML += `<button class="btn btn-sm ${activeClass} text-nowrap" onclick="changeBillCategory('${c}')">${c}</button>`;
        });
    }

    function changeBillCategory(cat) { currentBillCategory = cat; renderBillCategories(); renderBillMenuGrid(cat); }

    function renderBillMenuGrid(cat) {
        const grid = document.getElementById('billMenuGrid');
        grid.innerHTML = '';
        const items = cat === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ? allMenus : allMenus.filter(m => m.category === cat);
        if(items.length === 0) { grid.innerHTML = '<div class="text-center w-100 text-muted mt-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>'; return; }
        items.forEach(m => {
            const imgHtml = m.image_url ? `<img src="${m.image_url}" style="width:40px;height:40px;border-radius:5px;object-fit:cover;" class="me-2">` : '';
            grid.innerHTML += `
                <div class="col-6 col-lg-4">
                    <button class="btn w-100 menu-selector-btn d-flex align-items-center" onclick="addMenuToBill(${m.id})">
                        ${imgHtml}
                        <div style="overflow:hidden;"><div class="fw-bold text-truncate">${m.name}</div><small class="text-success">${m.price} ‡∏ø</small></div>
                    </button>
                </div>`;
        });
    }

    function renderBillItems() {
        const tbody = document.getElementById('billItemsDisplay');
        tbody.innerHTML = '';
        let total = 0;
        selectedOrder.items.forEach((item, index) => {
            const qty = item.qty || 1;
            const itemTotal = item.price * qty;
            total += itemTotal;
            tbody.innerHTML += `<tr>
                <td><div class="fw-bold">${item.name}</div>${item.option ? `<small class="text-muted">${item.option}</small>` : ''}</td>
                <td><div class="input-group input-group-sm" style="width: 90px;">
                    <button class="btn btn-outline-secondary px-2" onclick="adjustItem(${index},-1)">-</button>
                    <span class="form-control text-center px-0 bg-white">${qty}</span>
                    <button class="btn btn-outline-secondary px-2" onclick="adjustItem(${index},1)">+</button>
                </div></td>
                <td class="text-end fw-bold">${itemTotal.toLocaleString()}</td>
            </tr>`;
        });
        document.getElementById('modalTotal').innerText = total.toLocaleString() + " ‡∏ø";
    }

    async function adjustItem(idx, delta) {
        selectedOrder.items[idx].qty = (selectedOrder.items[idx].qty || 1) + delta;
        if (selectedOrder.items[idx].qty <= 0) { 
            if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) { selectedOrder.items[idx].qty=1; return; } 
            selectedOrder.items.splice(idx,1); 
        }
        await saveOrderUpdate();
    }

    async function addMenuToBill(menuId) {
        const m = allMenus.find(x => x.id === menuId);
        if(!m) return;
        const exist = selectedOrder.items.find(i => i.id === m.id && !i.option);
        if(exist) { exist.qty = (exist.qty || 1) + 1; } 
        else { selectedOrder.items.push({ id: m.id, name: m.name, price: m.price, qty: 1, option: '', note: '' }); }
        await saveOrderUpdate();
        Swal.mixin({ toast: true, position: 'center', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏° ' + m.name });
    }

    async function saveOrderUpdate() {
        const newTotal = selectedOrder.items.reduce((s,i)=>s+(i.price*(i.qty||1)),0);
        await db.from('orders').update({ items: selectedOrder.items, total_price: newTotal }).eq('id', selectedOrder.id);
        const { data } = await db.from('orders').select('*').eq('id', selectedOrder.id).single();
        selectedOrder = data;
        renderBillItems();
        fetchOrders();
    }

    async function checkBin() {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ?')) {
            await db.from('orders').update({status:'paid'}).eq('id', selectedOrder.id);
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            fetchOrders(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchOrders ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•
        }
    }

    // --- Menu Logic ---
    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        allMenus = data || [];
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        allMenus.forEach(m => {
            tbody.innerHTML += `<tr>
                <td><img src="${m.image_url||'https://via.placeholder.com/50'}" width="50" style="border-radius:5px"></td>
                <td>${m.name}</td>
                <td>${m.price}</td>
                <td><span class="badge bg-secondary">${m.category||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</span></td>
                <td>${m.is_available?'<span class="text-success">‡∏Ç‡∏≤‡∏¢</span>':'<span class="text-danger">‡∏´‡∏°‡∏î</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editMenu(${m.id})"><i class="fas fa-edit"></i></button> 
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function addToppingInput(name='', price=0) {
        const div = document.createElement('div');
        div.className = 'input-group mb-2 topping-row';
        div.innerHTML = `<input type="text" class="form-control topping-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${name}"><input type="number" class="form-control topping-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" value="${price}"><button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('toppingContainer').appendChild(div);
    }

    function openMenuModal() { 
        document.getElementById('menuForm').reset(); 
        document.getElementById('editMenuId').value=""; 
        document.getElementById('previewImg').src = 'https://via.placeholder.com/150?text=Upload';
        document.getElementById('toppingContainer').innerHTML=''; 
        addToppingInput(); 
        new bootstrap.Modal(document.getElementById('menuModal')).show(); 
    }
    
    function editMenu(id) {
        const m = allMenus.find(x=>x.id===id);
        document.getElementById('editMenuId').value=m.id; 
        document.getElementById('menuName').value=m.name; 
        document.getElementById('menuPrice').value=m.price; 
        document.getElementById('menuCategory').value=m.category;
        document.getElementById('previewImg').src=m.image_url||"https://via.placeholder.com/150?text=Upload";
        document.getElementById('toppingContainer').innerHTML='';
        if(m.options && m.options.length) m.options.forEach(o=>addToppingInput(o.name,o.price)); else addToppingInput();
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function previewImage(e) { if(e.target.files[0]) document.getElementById('previewImg').src = URL.createObjectURL(e.target.files[0]); }

    async function saveMenu() {
        const id = document.getElementById('editMenuId').value;
        const name = document.getElementById('menuName').value;
        const price = parseInt(document.getElementById('menuPrice').value);
        const category = document.getElementById('menuCategory').value;
        const tops = []; 
        document.querySelectorAll('.topping-row').forEach(r=>{ const n=r.querySelector('.topping-name').value.trim(); if(n) tops.push({name:n, price:parseInt(r.querySelector('.topping-price').value||0)}) });
        
        let img = document.getElementById('previewImg').src;
        if(img.includes('via.placeholder.com')) img = "";

        const fileIn = document.getElementById('menuImageFile');
        if(fileIn.files.length) {
            const file = fileIn.files[0]; 
            const fName=`menu_${Date.now()}`;
            const {error} = await db.storage.from('menu_images').upload(fName, file);
            if(!error) { const {data} = db.storage.from('menu_images').getPublicUrl(fName); img=data.publicUrl; }
        }
        
        const payload = {name, price, category, options:tops, image_url:img};
        if(id) await db.from('menu_items').update(payload).eq('id', id); else await db.from('menu_items').insert([payload]);
        bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide(); 
        fetchMenu();
    }

    async function deleteMenu(id) { 
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) { await db.from('menu_items').delete().eq('id', id); fetchMenu(); } 
    }

    // --- Report Logic ---
    async function renderReport(mode) {
        const tbody = document.getElementById('reportContent'); tbody.innerHTML='<div class="text-center py-4">Generating report...</div>';
        const { data } = await db.from('orders').select('*').eq('status','paid').order('created_at',{ascending:true});
        let summary={}, totalS=0, totalO=0;
        (data||[]).forEach(o=>{
            const d = new Date(o.created_at);
            const k = mode==='daily'?d.toLocaleDateString('th-TH'):d.toLocaleDateString('th-TH',{month:'long',year:'numeric'});
            if(!summary[k]) summary[k]={sales:0,count:0};
            summary[k].sales+=o.total_price; summary[k].count++; totalS+=o.total_price; totalO++;
        });
        document.getElementById('reportTotalSales').innerText=totalS.toLocaleString()+' ‡∏ø';
        document.getElementById('reportTotalOrders').innerText=totalO;
        let html = `<table class="table table-striped"><thead><tr><th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th class="text-end">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th class="text-center">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th>‡∏Å‡∏£‡∏≤‡∏ü</th></tr></thead><tbody>`;
        const max = Math.max(...Object.values(summary).map(s=>s.sales), 100);
        for(const [k,v] of Object.entries(summary)) {
            html += `<tr><td>${k}</td><td class="text-end fw-bold">${v.sales.toLocaleString()}</td><td class="text-center">${v.count}</td><td><div class="bar-container"><div class="bar-fill" style="width:${(v.sales/max)*100}%"></div></div></td></tr>`;
        }
        tbody.innerHTML = html+'</tbody></table>';
    }
</script>
</body>
</html>
