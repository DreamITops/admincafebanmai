<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Pro - Admin (Upgrade)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background: #eef2f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { width: 260px; height: 100vh; background: #2c3e50; color: white; position: fixed; padding: 20px; z-index: 100; overflow-y: auto; }
        .main { margin-left: 260px; padding: 30px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #b0b8c1; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; }
        
        /* Image Preview */
        .img-preview-container { width: 100px; height: 100px; border-radius: 10px; overflow: hidden; background: #ddd; position: relative; border: 2px dashed #999; display: flex; align-items: center; justify-content: center; cursor: pointer;}
        .img-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        
        @media(max-width: 992px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; }
            .main { margin-left: 0; }
            .show-sidebar .sidebar { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <h4 class="mb-4 ps-2 fw-bold text-warning"><i class="fas fa-utensils"></i> RestoPro</h4>
    <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-th-large"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô</div>
    <div class="nav-item" onclick="switchTab('menu', this)"><i class="fas fa-book-open"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</div>
    <div class="nav-item mt-5 text-danger" onclick="location.reload()"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="main">
    <button class="btn btn-dark d-lg-none mb-3" onclick="document.body.classList.toggle('show-sidebar')"><i class="fas fa-bars"></i> ‡πÄ‡∏°‡∏ô‡∏π</button>

    <div id="view-dashboard">
        <div class="row mb-4">
            <div class="col-md-6"><div class="card p-3 shadow-sm border-start border-4 border-primary"><h3><i class="fas fa-chair"></i> <span id="activeTables">0</span> ‡πÇ‡∏ï‡πä‡∏∞</h3></div></div>
            <div class="col-md-6"><div class="card p-3 shadow-sm border-start border-4 border-success"><h3><i class="fas fa-coins"></i> <span id="pendingSales">0</span> ‡∏ø (‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö)</h3></div></div>
        </div>
        <h5 class="fw-bold"><i class="fas fa-clipboard-list"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h5>
        <div class="row" id="orderGrid"><div class="col-12 text-center py-5">Loading...</div></div>
    </div>

    <div id="view-menu" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold"><i class="fas fa-hamburger"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
            <button class="btn btn-primary" onclick="openMenuModal()"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div class="card shadow-sm"><div class="card-body p-0 table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light"><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="menuTableBody"><tr><td colspan="6" class="text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
            </table>
        </div></div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="menuForm">
                    <input type="hidden" id="editMenuId"> <div class="d-flex justify-content-center mb-3">
                        <label class="img-preview-container" for="menuImageFile">
                            <img id="previewImg" src="https://via.placeholder.com/100?text=Upload" alt="Preview">
                            <input type="file" id="menuImageFile" accept="image/*" hidden onchange="previewImage(event)">
                        </label>
                    </div>
                    <p class="text-center small text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏û</p>

                    <div class="mb-2">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                        <input type="text" id="menuName" class="form-control" required>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="menuPrice" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="menuCategory" class="form-select">
                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                <option value="‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô">‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label>Options / Toppings (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°)</label>
                        <textarea id="menuOptions" class="form-control" rows="3" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏£‡πâ‡∏≠‡∏ô:0, ‡πÄ‡∏¢‡πá‡∏ô:5, ‡∏õ‡∏±‡πà‡∏ô:10"></textarea>
                        <small class="text-muted">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏ä‡∏∑‡πà‡∏≠:‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°, ‡∏ä‡∏∑‡πà‡∏≠:‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</code></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" onclick="saveMenu()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">‡πÇ‡∏ï‡πä‡∏∞ <span id="modalTableNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="billItemsDisplay" class="mb-3"></div>
                <h4 class="text-end text-primary fw-bold" id="modalTotal">0 ‡∏ø</h4>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success w-100 fw-bold" onclick="checkBin()">üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://cgevinayobbjvbjdoofx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnZXZpbmF5b2JianZiamRvb2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMzgxNTAsImV4cCI6MjA4NDkxNDE1MH0.buNGHEPFeYNNhb2mSpn_Q9KrjOYu-dnxDooZ4Ogv7DI';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allMenus = [];
    let currentOrders = [];
    let selectedOrder = null;

    // --- Init ---
    fetchOrders();
    db.channel('admin-upd').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => fetchOrders()).subscribe();

    function switchTab(view, btn) {
        document.getElementById('view-dashboard').classList.add('d-none');
        document.getElementById('view-menu').classList.add('d-none');
        document.getElementById('view-'+view).classList.remove('d-none');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(view === 'menu') fetchMenu();
        if(view === 'dashboard') fetchOrders();
    }

    // ================= DASHBOARD =================
    async function fetchOrders() {
        const { data } = await db.from('orders').select('*').neq('status', 'paid').order('updated_at', {ascending:false});
        currentOrders = data || [];
        renderDashboard();
    }
    
    function renderDashboard() {
        const grid = document.getElementById('orderGrid');
        grid.innerHTML = '';
        document.getElementById('activeTables').innerText = currentOrders.length;
        document.getElementById('pendingSales').innerText = currentOrders.reduce((a,b)=>a+b.total_price,0).toLocaleString();

        if(currentOrders.length === 0) { grid.innerHTML = '<div class="col-12 text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>'; return; }

        currentOrders.forEach(o => {
            let statusBadge = o.status==='pending' ? '<span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏ó‡∏≥</span>' : (o.status==='cooking'?'<span class="badge bg-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á</span>':'<span class="badge bg-success">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</span>');
            let btnAction = o.status==='pending' ? `<button class="btn btn-outline-warning w-100 btn-sm mb-2" onclick="setStatus(${o.id},'cooking')">üî• ‡∏õ‡∏£‡∏∏‡∏á</button>` : (o.status==='cooking' ? `<button class="btn btn-success w-100 btn-sm mb-2" onclick="setStatus(${o.id},'served')">‚úÖ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>` : '');
            
            grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card p-3 mb-3 shadow-sm border-0 border-start border-4 ${o.status === 'cooking' ? 'border-danger' : 'border-warning'}">
                        <div class="d-flex justify-content-between mb-2"><h5 class="m-0 fw-bold">‡πÇ‡∏ï‡πä‡∏∞ ${o.table_no}</h5>${statusBadge}</div>
                        <div class="bg-light p-2 rounded mb-2 small" style="max-height:100px;overflow-y:auto">
                            ${o.items.map(i=> `<div>${i.name} ${i.option?`(${i.option})`:''}</div>`).join('')}
                        </div>
                        <h5 class="text-primary text-end fw-bold">${o.total_price} ‡∏ø</h5>
                        ${btnAction}
                        <button class="btn btn-dark w-100 btn-sm" onclick="openBill(${o.id})">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</button>
                    </div>
                </div>`;
        });
    }

    async function setStatus(id, st) { await db.from('orders').update({status:st}).eq('id', id); }

    function openBill(id) {
        selectedOrder = currentOrders.find(o=>o.id===id);
        document.getElementById('modalTableNo').innerText = selectedOrder.table_no;
        document.getElementById('modalTotal').innerText = selectedOrder.total_price + ' ‡∏ø';
        document.getElementById('billItemsDisplay').innerHTML = selectedOrder.items.map(i=>
            `<div class="d-flex justify-content-between border-bottom py-1"><span>${i.name} ${i.option?`(${i.option})`:''} ${i.note?`<small class="text-danger">*${i.note}</small>`:''}</span><b>${i.price}</b></div>`
        ).join('');
        new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    async function checkBin() {
        if(confirm('‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô?')) {
            await db.from('orders').update({status:'paid'}).eq('id', selectedOrder.id);
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            fetchOrders();
        }
    }

    // ================= MENU MANAGER (UPGRADED) =================

    async function fetchMenu() {
        const { data } = await db.from('menu_items').select('*').order('id');
        allMenus = data || [];
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        allMenus.forEach(m => {
            tbody.innerHTML += `
                <tr>
                    <td><img src="${m.image_url || 'https://via.placeholder.com/50'}" width="50" height="50" style="object-fit:cover; border-radius:5px;"></td>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td><span class="badge bg-secondary">${m.category}</span></td>
                    <td>${m.is_available ? '<span class="text-success">‡∏Ç‡∏≤‡∏¢</span>' : '<span class="text-danger">‡∏´‡∏°‡∏î</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMenu(${m.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-warning" onclick="toggleMenu(${m.id}, ${!m.is_available})"><i class="fas fa-power-off"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMenu(${m.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // --- Add/Edit Logic ---
    function openMenuModal() {
        // Reset Form for "Add New"
        document.getElementById('modalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà";
        document.getElementById('menuForm').reset();
        document.getElementById('editMenuId').value = ""; // No ID = Add mode
        document.getElementById('previewImg').src = "https://via.placeholder.com/100?text=Upload";
        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function editMenu(id) {
        const menu = allMenus.find(m => m.id === id);
        if(!menu) return;

        // Populate Form for "Edit"
        document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π: " + menu.name;
        document.getElementById('editMenuId').value = menu.id;
        document.getElementById('menuName').value = menu.name;
        document.getElementById('menuPrice').value = menu.price;
        document.getElementById('menuCategory').value = menu.category || '‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
        
        // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        document.getElementById('previewImg').src = menu.image_url || "https://via.placeholder.com/100?text=No+Img";

        // ‡πÅ‡∏õ‡∏•‡∏á JSON Options ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô String (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Admin ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ)
        // Format: [{"name":"‡∏£‡πâ‡∏≠‡∏ô","price":0}] -> "‡∏£‡πâ‡∏≠‡∏ô:0"
        let optionStr = "";
        if(menu.options && Array.isArray(menu.options)) {
            optionStr = menu.options.map(o => `${o.name}:${o.price}`).join(', ');
        }
        document.getElementById('menuOptions').value = optionStr;

        new bootstrap.Modal(document.getElementById('menuModal')).show();
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if(file) {
            document.getElementById('previewImg').src = URL.createObjectURL(file);
        }
    }

    async function saveMenu() {
        const id = document.getElementById('editMenuId').value;
        const name = document.getElementById('menuName').value;
        const price = parseInt(document.getElementById('menuPrice').value);
        const category = document.getElementById('menuCategory').value;
        const optionText = document.getElementById('menuOptions').value;
        const fileInput = document.getElementById('menuImageFile');

        // 1. ‡πÅ‡∏õ‡∏•‡∏á Option String ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON
        let options = [];
        if(optionText.trim() !== "") {
            options = optionText.split(',').map(item => {
                const [n, p] = item.split(':');
                return { name: n.trim(), price: parseInt(p || 0) };
            });
        }

        // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà)
        let imageUrl = document.getElementById('previewImg').src; // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileName = `menu_${Date.now()}_${file.name}`; // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
            
            // Upload to Supabase Storage
            const { data, error } = await db.storage.from('menu_images').upload(fileName, file);
            
            if (error) {
                return Swal.fire('Upload Error', '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Bucket ‡∏ä‡∏∑‡πà‡∏≠ menu_images ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Public ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'error');
            }
            
            // Get Public URL
            const { data: urlData } = db.storage.from('menu_images').getPublicUrl(fileName);
            imageUrl = urlData.publicUrl;
        }

        const payload = { name, price, category, options, image_url: imageUrl };

        let error;
        if(id) {
            // UPDATE
            const res = await db.from('menu_items').update(payload).eq('id', id);
            error = res.error;
        } else {
            // INSERT
            const res = await db.from('menu_items').insert([payload]);
            error = res.error;
        }

        if(error) Swal.fire('Error', error.message, 'error');
        else {
            bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            fetchMenu();
        }
    }

    async function toggleMenu(id, st) { await db.from('menu_items').update({is_available:st}).eq('id', id); fetchMenu(); }
    async function deleteMenu(id) { if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ?')) { await db.from('menu_items').delete().eq('id', id); fetchMenu(); } }

</script>
</body>
</html>
